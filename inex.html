<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mora For Studying - Cinematic Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    <style>
        :root {
            --bg-color: #020617; --primary-glow: #22d3ee; --secondary-glow: #a78bfa;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.55); --glass-border: rgba(56, 189, 248, 0.2);
        }
        html[data-theme="gold"] { --primary-glow: #f59e0b; --secondary-glow: #fbbf24; }
        html[data-theme="emerald"] { --primary-glow: #10b981; --secondary-glow: #34d399; }
        html[data-theme="crimson"] { --primary-glow: #dc2626; --secondary-glow: #f87171; }
        
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-color); color: var(--text-primary); overflow: hidden; transition: background-color 0.5s ease; }
        #app-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(at 20% 20%, var(--primary-glow) 0px, transparent 30%), radial-gradient(at 80% 80%, var(--secondary-glow) 0px, transparent 30%); animation: bg-pan 20s linear infinite alternate; opacity: 0.2; z-index: -1; transition: background-image 0.5s ease; }
        
        @keyframes bg-pan { from { transform: scale(1) rotate(0deg); } to { transform: scale(1.2) rotate(45deg); } }
        @keyframes cinematic-enter { from { opacity: 0; transform: scale(1.05); filter: blur(8px); } to { opacity: 1; transform: scale(1); filter: blur(0); } }
        @keyframes page-enter { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes glowing-logo-pulse { 0%, 100% { box-shadow: 0 0 20px var(--primary-glow), 0 0 40px var(--primary-glow); } 50% { box-shadow: 0 0 30px var(--secondary-glow), 0 0 60px var(--secondary-glow); } }
        @keyframes float-in { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0px); } }
        @keyframes scroll-text-rtl { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
        @keyframes lock-3d-swing { 0% { transform: perspective(100px) rotateY(-15deg); } 50% { transform: perspective(100px) rotateY(15deg) scale(1.1); } 100% { transform: perspective(100px) rotateY(-15deg); } }
        @keyframes slow-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes icon-orbit { 0% { transform: translateY(0px) scale(1); } 25% { transform: translateY(-10px) scale(1.1); } 50% { transform: translateY(0px) scale(1); } 75% { transform: translateY(10px) scale(1.1); } 100% { transform: translateY(0px) scale(1); } }

        .page { position: absolute; width: 100%; height: 100%; display: none; opacity: 0; animation: page-enter 0.5s ease forwards; }
        .page.active { display: flex; flex-direction: column; }
        #landing-page.active { animation: cinematic-enter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        .glass-effect { background: var(--glass-bg); -webkit-backdrop-filter: blur(15px); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); }
        .glowing-logo { animation: glowing-logo-pulse 4s infinite ease-in-out; }
        .input-field, .select-field { background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border); color: var(--text-primary); transition: all 0.3s ease; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .input-field:focus, .select-field:focus { box-shadow: 0 0 15px var(--primary-glow); border-color: var(--primary-glow); outline: none; }
        .input-field::placeholder { color: var(--text-secondary); }

        .btn-celestial { background: transparent; border: 2px solid var(--primary-glow); color: var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow); box-shadow: 0 0 15px var(--primary-glow) inset, 0 0 5px var(--primary-glow); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .btn-celestial:hover:not(:disabled) { background: var(--primary-glow); color: var(--bg-color); transform: scale(1.05); box-shadow: 0 0 25px var(--primary-glow) inset, 0 0 20px var(--primary-glow); text-shadow: none; }
        .btn-celestial:disabled { opacity: 0.5; cursor: not-allowed; }

        .auth-form-item { animation: float-in 0.5s ease forwards; opacity: 0; }
        .landing-btn { animation: slow-float 4s infinite ease-in-out; }
        .scrolling-banner { position: absolute; top: 0; left: 0; width: 100%; background: rgba(2, 6, 23, 0.5); backdrop-filter: blur(5px); white-space: nowrap; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 60; }
        .scrolling-banner p { display: inline-block; padding: 6px 0; font-size: 0.8rem; animation: scroll-text-rtl 25s linear infinite; color: var(--primary-glow); text-shadow: 0 0 8px var(--primary-glow); font-weight: 600; }
        .bottom-nav { gap: 0.5rem; padding: 0.5rem; justify-content: space-around; }
        .bottom-nav-btn i { filter: drop-shadow(0 0 5px var(--primary-glow)); transition: all 0.3s ease; }
        .bottom-nav-btn:hover i { filter: drop-shadow(0 0 15px var(--primary-glow)); transform: scale(1.1) translateY(-2px); color: var(--primary-glow); }
        .lock-icon-3d { animation: lock-3d-swing 2.5s infinite ease-in-out; display: inline-block; }
        .modal { display: none; } .modal.open { display: flex; }
        #modal-body { scrollbar-width: thin; scrollbar-color: var(--primary-glow) transparent; }
        .social-icon { animation: icon-orbit 5s infinite ease-in-out; }
    </style>
</head>
<body class="w-full h-screen">
    <div id="app-bg"></div>

    <div id="app-container" class="w-full h-full relative">

        <div id="landing-page" class="page justify-center items-center p-4 text-center">
            <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="" class="w-32 h-32 rounded-full mb-6 glowing-logo mx-auto">
            <h1 class="text-4xl font-bold mb-2 tracking-wider text-shadow">Mora For Studying</h1>
            <p class="text-lg text-slate-300 mb-10">مرحباً بك في مستقبل التعليم</p>
            <div class="space-y-6">
                <button id="go-to-register-btn" class="py-3 px-12 rounded-lg text-lg font-bold btn-celestial landing-btn" style="animation-delay: -2s;">إنشاء حساب</button>
                <button id="go-to-login-btn" class="py-3 px-12 rounded-lg text-lg font-bold btn-celestial landing-btn">تسجيل الدخول</button>
            </div>
        </div>

        <div id="auth-page" class="page justify-center items-center p-4"></div>
        
        <div id="student-dashboard" class="page h-screen w-screen overflow-hidden">
            <div class="scrolling-banner"><p>شكر خاص لإدارة المعهد وأعضاء هيئة التدريس في تطوير هذا الموقع التعليمي ***&nbsp;</p></div>
            <header class="p-4 flex justify-between items-center glass-effect mt-10"><img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="Logo" class="w-12 h-12 rounded-full glowing-logo"><div class="text-right"><h2 id="welcome-name" class="font-bold">مرحباً يا ...</h2><p id="user-details" class="text-xs text-slate-400">...</p><div class="flex items-center justify-end gap-2 mt-1"><i id="rewards-icon" class="ph-trophy text-xl text-yellow-400 cursor-pointer"></i><span id="points-display" class="text-yellow-400 font-bold">0</span></div></div></header>
            <main class="flex-grow p-4 overflow-y-auto pb-24"><h3 class="text-2xl font-bold mb-4 text-slate-300">المواد الدراسية</h3><div id="materials-list" class="space-y-3"></div></main>
            <nav class="fixed bottom-0 right-0 left-0 glass-effect flex text-xs z-50 bottom-nav">
                <button onclick="openContentModal('books')" class="bottom-nav-btn flex flex-col items-center space-y-1"><i class="ph-books text-2xl"></i><span>الكتب</span></button>
                <button onclick="openContentModal('sections')" class="bottom-nav-btn flex flex-col items-center space-y-1"><i class="ph-stack-simple text-2xl"></i><span>السكاشن</span></button>
                <button id="meeting-btn" class="bottom-nav-btn flex flex-col items-center space-y-1"><i class="ph-lock-key lock-icon-3d text-2xl"></i><span>ميتنج</span></button>
                <button id="courses-btn" class="bottom-nav-btn flex flex-col items-center space-y-1"><i id="courses-icon" class="ph-lock-key lock-icon-3d text-2xl"></i><span>كورسات</span></button>
                <button data-modal="ai-tools-modal" class="bottom-nav-btn flex flex-col items-center space-y-1"><i class="ph-robot text-2xl"></i><span>أدوات AI</span></button>
                <button data-modal="opinions-modal" class="bottom-nav-btn flex flex-col items-center space-y-1"><i class="ph-chats-teardrop text-2xl"></i><span>آراء</span></button>
                <button data-modal="about-modal" class="bottom-nav-btn flex flex-col items-center space-y-1"><i class="ph-info text-2xl"></i><span>عنا</span></button>
                <button data-modal="settings-modal" class="bottom-nav-btn flex flex-col items-center space-y-1"><i class="ph-gear-six text-2xl"></i><span>الإعدادات</span></button>
            </nav>
        </div>
        
        <div id="admin-dashboard" class="page h-screen w-screen overflow-hidden">
             <div class="flex h-full">
                <aside class="w-72 glass-effect p-4 flex flex-col"><h1 class="text-2xl font-bold text-[var(--primary-glow)] mb-8">لوحة التحكم</h1><nav class="flex flex-col space-y-2"><button data-panel="info-panel" class="admin-nav-btn text-right p-3 rounded-lg hover:bg-slate-700/50 transition">لوحة المعلومات</button><button data-panel="students-panel" class="admin-nav-btn text-right p-3 rounded-lg hover:bg-slate-700/50 transition">إدارة الطلاب</button><button data-panel="content-panel" class="admin-nav-btn text-right p-3 rounded-lg hover:bg-slate-700/50 transition">إدارة المحتوى</button><button data-panel="opinions-panel" class="admin-nav-btn text-right p-3 rounded-lg hover:bg-slate-700/50 transition">آراء الطلاب</button></nav><div class="mt-auto"><button id="admin-logout-btn" class="w-full py-2 rounded-lg text-lg font-bold btn-celestial border-red-500 text-red-500 hover:bg-red-500 hover:text-white">خروج</button></div></aside>
                <main class="flex-grow p-8 overflow-y-auto"><div id="info-panel" class="admin-panel"><h2 class="text-3xl font-bold mb-6">لوحة المعلومات</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center"><div class="glass-effect p-6 rounded-lg"><h3 class="text-xl text-slate-400">إجمالي الطلاب</h3><p id="admin-student-count" class="text-4xl font-bold text-[var(--primary-glow)] mt-2">0</p></div><div class="glass-effect p-6 rounded-lg"><h3 class="text-xl text-slate-400">إجمالي الآراء</h3><p id="admin-opinions-count" class="text-4xl font-bold text-[var(--secondary-glow)] mt-2">0</p></div></div></div><div id="students-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">إدارة الطلاب</h2><div id="admin-students-list" class="space-y-4"></div></div><div id="content-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">إدارة المحتوى</h2><div class="glass-effect p-6 rounded-lg"><select id="content-type-select" class="w-full p-3 rounded-lg select-field appearance-none mb-4"><option value="lectures">محاضرة</option><option value="books">كتاب</option><option value="sections">سكشن</option></select><select id="content-year-select" class="w-full p-3 rounded-lg select-field appearance-none mb-4"><option value="">اختر الفرقة</option><option value="1">الأولى</option><option value="2">الثانية</option></select><select id="content-division-select" class="w-full p-3 rounded-lg select-field appearance-none mb-4"><option value="">اختر الشعبة</option><option value="international">أعمال دولية</option><option value="systems">نظم معلومات</option></select><select id="content-subject-select" class="w-full p-3 rounded-lg select-field appearance-none mb-4"><option value="">اختر المادة أولاً</option></select><input id="content-title-input" type="text" placeholder="عنوان المحتوى" class="w-full p-3 rounded-lg input-field mb-4"><textarea id="content-body-input" placeholder="نص المحتوى أو الرابط..." class="w-full p-3 rounded-lg input-field mb-4" rows="5"></textarea><button id="save-content-btn" class="w-full py-2 rounded-lg text-lg font-bold btn-celestial">حفظ المحتوى</button></div></div><div id="opinions-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">آراء الطلاب</h2><div id="admin-opinions-list" class="space-y-4"></div></div></main>
            </div>
        </div>
    </div>
    
    <div id="generic-modal" class="modal fixed inset-0 bg-black/60 backdrop-blur-md z-[1000] justify-center items-center p-4"><div class="modal-content glass-effect w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 rounded-2xl flex flex-col"><div class="flex justify-between items-center mb-4 flex-shrink-0"><h3 id="modal-title" class="text-2xl font-bold text-[var(--primary-glow)]"></h3><button class="modal-close-btn text-3xl hover:text-red-500 transition">&times;</button></div><div id="modal-body" class="overflow-y-auto flex-grow"></div></div></div>
    <div id="toast-notification" class="fixed top-5 right-5 glass-effect p-4 rounded-lg shadow-lg z-[2000] opacity-0 -translate-y-12 transition-all duration-500"><p id="toast-message"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDocs, query, where, onSnapshot, deleteDoc, updateDoc, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyB92ooyA5_tTx1BLDp2EWmqxHuJQ3zqah4", authDomain: "mora-for-studying.firebaseapp.com", projectId: "mora-for-studying", storageBucket: "mora-for-studying.firebasestorage.app", messagingSenderId: "213416531900", appId: "1:213416531900:web:2e4d8bd2a9e1a4e814bdb9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentUser = null;
        const materials = { '1_international': [ 'مبادئ المحاسبة الماليه', 'مبادئ الاقتصاد', 'مبادئ القانون', 'لغه اجنبيه (1)', 'مبادئ اداره الاعمال' ], '1_systems': ['طرق ومهارات الاتصال', 'رياضيات الاعمال', 'حقوق الانسان', 'التفكير الابتكاري', 'السلوك التنظيمي', 'اساسيات الحاسب وتكتولوچيا المعلومات'], '2_international': ['اداره اللوچيستيات وسلاسل الامداد', 'مبادئ التسويق', 'مبادئ الاقتصاد الجزئي', 'محاسبه التكاليف', 'قانون الاعمال'], '2_systems': ['قانون الاعمال', 'قواعد البيانات (1)', 'اداره الانتاج', 'محاسبه الشركات', 'تصميم برامج الحاسب'] };

        const authPageEl = document.getElementById('auth-page');
        const studentDashboardEl = { welcomeName: document.getElementById('welcome-name'), userDetails: document.getElementById('user-details'), materialsList: document.getElementById('materials-list'), pointsDisplay: document.getElementById('points-display') };
        const adminDashboardEl = { studentCount: document.getElementById('admin-student-count'), opinionsCount: document.getElementById('admin-opinions-count'), studentsList: document.getElementById('admin-students-list'), opinionsList: document.getElementById('admin-opinions-list') };
        const adminContentPanelEl = { type: document.getElementById('content-type-select'), year: document.getElementById('content-year-select'), division: document.getElementById('content-division-select'), subject: document.getElementById('content-subject-select'), title: document.getElementById('content-title-input'), body: document.getElementById('content-body-input'), saveBtn: document.getElementById('save-content-btn') };

        function showPage(pageId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
        function showToast(message, isError = false) { const t = document.getElementById('toast-notification'), m = document.getElementById('toast-message'); m.textContent = message; t.className = `fixed top-5 right-5 glass-effect p-4 rounded-lg shadow-lg z-[2000] opacity-100 translate-y-0 transition-all duration-500 ${isError ? 'bg-red-500/50 text-white' : 'bg-green-500/50 text-white'}`; setTimeout(() => { t.className = t.className.replace('opacity-100', 'opacity-0').replace('translate-y-0', '-translate-y-12'); }, 3000); }
        function generateCaptcha() { return Math.floor(1000 + Math.random() * 9000); }
        function openModalWithContent(title, body) { document.getElementById('modal-title').textContent = title; document.getElementById('modal-body').innerHTML = body; document.getElementById('generic-modal').classList.add('open'); }

        function renderAuthForm(isRegister = false) {
            const captcha = generateCaptcha();
            authPageEl.innerHTML = `<div class="text-center w-full max-w-md"><img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="Logo" class="w-32 h-32 rounded-full mb-6 glowing-logo mx-auto auth-form-item"><h1 class="text-3xl font-bold mb-8 tracking-wider auth-form-item" style="animation-delay:0.1s;">${isRegister ? 'إنشاء حساب جديد' : 'تسجيل الدخول'}</h1><div class="space-y-4"><input type="text" id="auth-name" placeholder="الاسم" class="w-full p-3 rounded-lg text-center input-field auth-form-item" style="animation-delay:0.2s;">${isRegister ? `<input type="text" id="auth-city" placeholder="المدينة" class="w-full p-3 rounded-lg text-center input-field auth-form-item" style="animation-delay:0.3s;"><select id="auth-year" class="w-full p-3 rounded-lg text-center select-field appearance-none auth-form-item" style="animation-delay:0.4s;"><option value="">اختر الفرقة</option><option value="1">الأولى</option><option value="2">الثانية</option></select><select id="auth-division" class="w-full p-3 rounded-lg text-center select-field appearance-none auth-form-item" style="animation-delay:0.5s;"><option value="">اختر الشعبة</option><option value="international">أعمال دولية</option><option value="systems">نظم معلومات</option></select>` : ''}<div class="relative auth-form-item" style="animation-delay:${isRegister ? '0.6s' : '0.3s'};"><input type="password" id="auth-password" placeholder="كلمة المرور" class="w-full p-3 rounded-lg text-center input-field"></div>${isRegister ? `<div class="flex items-center justify-center gap-4 auth-form-item" style="animation-delay:0.7s;"><span id="captcha-challenge" class="p-3 glass-effect rounded-lg font-bold text-2xl tracking-widest">${captcha}</span><input type="text" id="captcha-input" placeholder="أدخل الرقم" class="w-32 p-3 rounded-lg text-center input-field"></div>` : ''}<p id="auth-error-msg" class="text-red-400 h-6 auth-form-item" style="animation-delay:${isRegister ? '0.8s' : '0.4s'};"></p><button id="auth-submit-btn" class="w-full py-3 rounded-lg text-lg font-bold btn-celestial auth-form-item" style="animation-delay:${isRegister ? '0.9s' : '0.5s'};">${isRegister ? 'سجل الآن' : 'دخــــول'}</button><button id="auth-toggle-btn" class="text-sm text-slate-400 hover:text-[var(--primary-glow)] transition auth-form-item" style="animation-delay:${isRegister ? '1.0s' : '0.6s'};">${isRegister ? 'لديك حساب بالفعل؟' : 'ليس لديك حساب؟'}</button></div></div>`;
            document.getElementById('auth-toggle-btn').addEventListener('click', () => renderAuthForm(!isRegister));
            document.getElementById('auth-submit-btn').addEventListener('click', isRegister ? handleRegister : handleLogin);
        }
        document.getElementById('go-to-register-btn').addEventListener('click', () => { showPage('auth-page'); renderAuthForm(true); });
        document.getElementById('go-to-login-btn').addEventListener('click', () => { showPage('auth-page'); renderAuthForm(false); });
        async function handleRegister() {
            const name = document.getElementById('auth-name').value.trim(), city = document.getElementById('auth-city').value.trim(), year = document.getElementById('auth-year').value, division = document.getElementById('auth-division').value, password = document.getElementById('auth-password').value, captchaInput = document.getElementById('captcha-input').value, captchaChallenge = document.getElementById('captcha-challenge').textContent, errorMsg = document.getElementById('auth-error-msg');
            if (!name || !city || !year || !division || !password) { errorMsg.textContent = 'يرجى ملء جميع الحقول'; return; }
            if (password.length < 8) { errorMsg.textContent = 'كلمة المرور قصيرة جداً (8 أحرف على الأقل)'; return; }
            if (captchaInput !== captchaChallenge) { errorMsg.textContent = 'رمز التحقق غير صحيح'; return; }
            const q = query(collection(db, "users"), where("name", "==", name));
            if (!(await getDocs(q)).empty) { errorMsg.textContent = 'هذا الاسم مستخدم'; return; }
            await addDoc(collection(db, "users"), { name, city, year, division, password, points: 0, isBanned: false, createdAt: serverTimestamp() });
            showToast('تم إنشاء الحساب بنجاح!');
            renderAuthForm(false); document.getElementById('auth-name').value = name; document.getElementById('auth-password').value = password;
        }
        async function handleLogin() {
            const name = document.getElementById('auth-name').value.trim(), password = document.getElementById('auth-password').value, errorMsg = document.getElementById('auth-error-msg');
            if (!name || !password) { errorMsg.textContent = 'يرجى إدخال البيانات'; return; }
            if (name === 'admen' && password === 'Amr1221@gmail.com') { currentUser = { name: 'Admin', isAdmin: true }; sessionStorage.setItem('moraUser', JSON.stringify(currentUser)); initAdminDashboard(); return; }
            const q = query(collection(db, "users"), where("name", "==", name), where("password", "==", password));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { errorMsg.textContent = 'البيانات غير صحيحة'; return; }
            const userDoc = snapshot.docs[0];
            if (userDoc.data().isBanned) { errorMsg.textContent = 'هذا الحساب محظور'; return; }
            currentUser = { id: userDoc.id, ...userDoc.data() };
            sessionStorage.setItem('moraUser', JSON.stringify(currentUser));
            initStudentDashboard();
        }
        function initStudentDashboard() {
            showPage('student-dashboard');
            studentDashboardEl.welcomeName.textContent = `مرحباً يا ${currentUser.name}`;
            studentDashboardEl.userDetails.textContent = `${'1' === currentUser.year ? "الفرقة الأولى" : "الفرقة الثانية"} - ${"international" === currentUser.division ? "أعمال دولية" : "نظم معلومات"}`;
            studentDashboardEl.pointsDisplay.textContent = currentUser.points || 0;
            loadMaterialsForStudent(); checkCourseUnlock();
        }
        function loadMaterialsForStudent() { const userMaterials = materials[`${currentUser.year}_${currentUser.division}`] || []; studentDashboardEl.materialsList.innerHTML = userMaterials.map(mat => `<div class="glass-effect p-4 rounded-lg flex justify-between items-center cursor-pointer hover:bg-[var(--glass-border)] transition" onclick="openLectureContent('${mat}')"><h4 class="text-lg font-semibold">${mat}</h4><i class="ph-caret-left text-xl"></i></div>`).join(''); }
        window.openLectureContent = async (subject) => {
            const q = query(collection(db, "lectures"), where("year", "==", currentUser.year), where("division", "==", currentUser.division), where("subject", "==", subject));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { openModalWithContent('المحاضرة غير متوفرة', `<div class="text-center p-8"><i class="ph-clock-counter-clockwise text-6xl text-[var(--secondary-glow)] mb-4"></i><h3 class="text-xl font-bold mb-2">قريباً...</h3><p class="text-slate-400">سوف يتم إضافة هذا المحتوى من قبل المطور قريباً.</p><p class="mt-6 text-sm text-[var(--primary-glow)]">تطوير Amr lotfy</p></div>`); } 
            else {
                const newPoints = (currentUser.points || 0) + 25;
                await updateDoc(doc(db, "users", currentUser.id), { points: newPoints });
                currentUser.points = newPoints; sessionStorage.setItem('moraUser', JSON.stringify(currentUser));
                studentDashboardEl.pointsDisplay.textContent = newPoints; checkCourseUnlock();
                showToast('تمت إضافة 25 نقطة! ✨');
                const contentDoc = snapshot.docs[0].data();
                openModalWithContent(contentDoc.title, `<div class="p-4">${contentDoc.body.replace(/\n/g, '<br>')}</div>`);
            }
        };
        window.openContentModal = async (type) => { const q = query(collection(db, type), where("year", "==", currentUser.year), where("division", "==", currentUser.division)); const snapshot = await getDocs(q); let content = ''; if (snapshot.empty) { content = `<div class="text-center p-4"><p>لا يوجد محتوى في هذا القسم حالياً.</p></div>`; } else { content = '<div class="space-y-3">'; snapshot.forEach(doc => { const item = doc.data(); content += `<div class="glass-effect p-3 rounded-lg"><h4 class="font-bold text-[var(--primary-glow)]">${item.title} (${item.subject})</h4><p class="text-sm mt-2">${item.body}</p></div>`; }); content += '</div>'; } const title = type === 'books' ? 'الكتب الدراسية' : 'السكاشن'; openModalWithContent(title, content); };
        function checkCourseUnlock() { const icon = document.getElementById('courses-icon'); if (currentUser.points >= 100) { icon.classList.remove('ph-lock-key', 'lock-icon-3d'); icon.classList.add('ph-video'); } else { icon.classList.add('ph-lock-key', 'lock-icon-3d'); icon.classList.remove('ph-video'); } }
        document.getElementById('meeting-btn').addEventListener('click', () => showToast('سوف يتم فتح هذا القسم عند شرح المواد اونلاين'));
        document.getElementById('courses-btn').addEventListener('click', () => { if (currentUser.points >= 100) { openModalWithContent('الكورسات المجانية', `<div>...</div>`); } else { showToast(`لفتح هذا القسم يجب عليك جمع 100 نقطة. تطوير Amr lotfy`, true); }});
        
        function initAdminDashboard() {
            showPage('admin-dashboard');
            const navBtns = document.querySelectorAll('.admin-nav-btn'), panels = document.querySelectorAll('.admin-panel');
            navBtns.forEach(btn => btn.addEventListener('click', e => { navBtns.forEach(b => b.classList.remove('bg-[var(--primary-glow)]/30')); e.currentTarget.classList.add('bg-[var(--primary-glow)]/30'); panels.forEach(p => p.classList.add('hidden')); document.getElementById(e.currentTarget.dataset.panel).classList.remove('hidden'); }));
            navBtns[0].click();
            
            onSnapshot(collection(db, "users"), (snap) => { adminDashboardEl.studentCount.textContent = snap.size; });
            onSnapshot(collection(db, "opinions"), (snap) => { adminDashboardEl.opinionsCount.textContent = snap.size; });
            onSnapshot(query(collection(db, "users")), s => { let h = ''; s.forEach(d => { const u = d.data(), b = u.isBanned || false; h += `<div class="glass-effect p-4 rounded-lg"><div class="flex justify-between items-center"><div><p class="font-bold text-lg text-white">${u.name}</p><p class="text-sm text-slate-400">كلمة المرور: ${u.password}</p></div><div class="flex gap-2"><button onclick="toggleBan('${d.id}', ${b})" class="px-3 py-1 text-sm rounded ${b ? 'bg-green-600' : 'bg-yellow-600'}">${b ? 'إلغاء الحظر' : 'حظر'}</button><button onclick="deleteUser('${d.id}')" class="px-3 py-1 text-sm rounded bg-red-600">حذف</button></div></div><div class="mt-2 pt-2 border-t border-slate-700 text-xs text-slate-300">فرقة ${u.year} | ${u.division} | ${u.city}</div></div>`; }); adminDashboardEl.studentsList.innerHTML = h; });
            onSnapshot(query(collection(db, "opinions"), orderBy('createdAt', 'desc')), s => { let h = ''; s.forEach(d => { const o = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p>"${o.text}"</p><p class="text-sm text-slate-400 mt-2 font-bold">${o.name} - فرقة ${o.year}</p></div><button onclick="deleteOpinion('${d.id}')" class="px-3 py-1 text-sm rounded bg-red-600">حذف</button></div>`; }); adminDashboardEl.opinionsList.innerHTML = h; });
            
            const updateSubjects = () => { const y = adminContentPanelEl.year.value, d = adminContentPanelEl.division.value; adminContentPanelEl.subject.innerHTML = '<option value="">اختر المادة</option>'; if (y && d) { (materials[`${y}_${d}`] || []).forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; adminContentPanelEl.subject.appendChild(o); }); } };
            adminContentPanelEl.year.addEventListener('change', updateSubjects); adminContentPanelEl.division.addEventListener('change', updateSubjects);
        }
        window.toggleBan = async (id, ban) => { if(confirm(`هل أنت متأكد من ${ban ? 'إلغاء حظر' : 'حظر'} هذا الطالب؟`)) { await updateDoc(doc(db, 'users', id), { isBanned: !ban }); showToast('تم تحديث حالة الطالب.'); } };
        window.deleteUser = async (id) => { if(confirm('هل أنت متأكد من الحذف النهائي؟ لا يمكن التراجع عن هذا الإجراء.')) { await deleteDoc(doc(db, 'users', id)); showToast('تم حذف الطالب.'); } };
        window.deleteOpinion = async (id) => { if(confirm('هل أنت متأكد من حذف الرأي؟')) { await deleteDoc(doc(db, 'opinions', id)); showToast('تم حذف الرأي.'); } };
        adminContentPanelEl.saveBtn.addEventListener('click', async () => { const data = { year: adminContentPanelEl.year.value, division: adminContentPanelEl.division.value, subject: adminContentPanelEl.subject.value, title: adminContentPanelEl.title.value.trim(), body: adminContentPanelEl.body.value.trim(), createdAt: serverTimestamp() }; if (!data.year || !data.division || !data.subject || !data.title || !data.body) { showToast('يرجى ملء جميع الحقول', true); return; } await addDoc(collection(db, adminContentPanelEl.type.value), data); showToast('تم حفظ المحتوى بنجاح!'); adminContentPanelEl.title.value = ''; adminContentPanelEl.body.value = ''; });
        
        document.querySelectorAll('.bottom-nav-btn[data-modal]').forEach(btn => btn.addEventListener('click', e => {
            const type = e.currentTarget.dataset.modal;
            if (type === 'opinions-modal') {
                 openModalWithContent('آراء الطلاب', `<div id="opinions-view" class="space-y-3 mb-4 max-h-60 overflow-y-auto"></div><textarea id="opinion-input" class="w-full p-3 rounded-lg input-field mt-4" rows="3" placeholder="اكتب رأيك هنا..."></textarea><button id="submit-opinion-btn" class="w-full mt-2 py-2 rounded-lg font-bold btn-celestial">نشر الرأي</button>`);
                 onSnapshot(query(collection(db, "opinions"), orderBy('createdAt', 'desc')), snap => { document.getElementById('opinions-view').innerHTML = snap.docs.map(d => { const o = d.data(); return `<div class="glass-effect p-3 rounded-lg"><p>"${o.text}"</p><p class="text-xs text-slate-400 mt-2 font-bold">${o.name} - فرقة ${o.year}</p></div>`; }).join('') || '<p class="text-center text-slate-400">لا توجد آراء بعد. كن أول من يكتب رأياً!</p>'; });
            }
            if (type === 'about-modal') {
                openModalWithContent('عن المنصة', `<div class="text-center p-2"><p class="text-lg text-slate-300 mb-4">هذا الموقع خاص بالفرقة الأولى والثانية لطلاب المعهد العالي للحاسبات والمعلومات بطنطا.</p><p class="font-bold text-slate-400 mb-2">تحت رعاية</p><div class="space-y-1 mb-6"><p style="color:var(--primary-glow); font-weight:bold;">ا. د/ عبدالمنعم الدسوقي</p><p style="color:var(--secondary-glow); font-weight:bold;">ا. د/ابراهيم ماريه</p><p style="color:var(--primary-glow); font-weight:bold;">ا. د/مصطفى عبدالمنعم</p><p style="color:var(--secondary-glow); font-weight:bold;">ا. د/محمد حجازي</p></div><div class="flex justify-center items-center gap-6 my-8">${['https://wa.me/201067941806', 'https://www.facebook.com/share/1CDtFCSPVD/', 'mailto:amrloutfy2006@gmail.com'].map((l, i) => `<a href="${l}" target="_blank" class="social-icon text-3xl hover:text-[var(--primary-glow)] transition" style="animation-delay:-${i*1.5}s">${['ph-whatsapp-logo', 'ph-facebook-logo', 'ph-envelope'][i] ? `<i class="${['ph-whatsapp-logo', 'ph-facebook-logo', 'ph-envelope'][i]}"></i>`: ''}</a>`).join('')}</div><div class="grid grid-cols-2 gap-2 my-4 text-sm"><div id="rating-container"><button id="rate-site-btn" class="w-full glass-effect p-2 rounded-lg hover:border-[var(--primary-glow)] transition border border-transparent">قيم الموقع</button></div><button id="my-blog-btn" class="w-full glass-effect p-2 rounded-lg hover:border-[var(--primary-glow)] transition border border-transparent">مدونتي</button></div><p class="mt-8 text-sm text-[var(--primary-glow)]">تطوير Amr lotfy - إصدار 11.0</p><div class="grid grid-cols-2 gap-2 mt-4"><button id="clear-data-btn" class="w-full py-2 rounded-lg text-sm btn-celestial">محو البيانات</button><button id="logout-btn" class="w-full py-2 rounded-lg text-sm btn-celestial border-red-500 text-red-500 hover:bg-red-500 hover:text-white">تسجيل الخروج</button></div></div>`);
            }
            if (type === 'settings-modal') openModalWithContent('الإعدادات', `<div class="space-y-4"><h4 class="font-semibold">اختر المظهر</h4><div class="grid grid-cols-2 gap-2"><button data-theme="default" class="theme-btn p-2 rounded bg-cyan-500 text-white">افتراضي</button><button data-theme="gold" class="theme-btn p-2 rounded bg-amber-500 text-black">ذهبي</button><button data-theme="emerald" class="theme-btn p-2 rounded bg-emerald-500 text-white">زمردي</button><button data-theme="crimson" class="theme-btn p-2 rounded bg-red-600 text-white">قرمزي</button></div></div>`);
            if (type === 'ai-tools-modal') {
                const tools = [{n:'ChatGPT', d:'مساعد كتابة ونصوص', u:'https://chat.openai.com'}, {n:'Midjourney', d:'مولد صور بالذكاء الاصطناعي', u:'https://www.midjourney.com'}, {n:'GitHub Copilot', d:'مساعد برمجة ذكي', u:'https://github.com/features/copilot'}, {n:'Notion AI', d:'تنظيم الأفكار والملاحظات', u:'https://www.notion.so/product/ai'}, {n:'RunwayML', d:'تحرير فيديو احترافي', u:'https://runwayml.com'}, {n:'Canva AI', d:'تصميم جرافيك سهل', u:'https://www.canva.com/ai-image-generator/'}, {n:'Grammarly', d:'تصحيح لغوي ونحوي', u:'https://www.grammarly.com'}, {n:'QuillBot', d:'إعادة صياغة النصوص', u:'https://quillbot.com'}, {n:'Lumen5', d:'تحويل النصوص لفيديو', u:'https://lumen5.com'}, {n:'Fireflies.ai', d:'تلخيص الاجتماعات', u:'https://fireflies.ai'}, {n:'Gemini (Bard)', d:'مساعد إبداعي من جوجل', u:'https://gemini.google.com'}, {n:'DeepL', d:'ترجمة دقيقة جداً', u:'https://www.deepl.com/translator'}, {n:'Tome', d:'إنشاء عروض تقديمية', u:'https://tome.app'}, {n:'Poe', d:'منصة متعددة البوتات', u:'https://poe.com'}];
                openModalWithContent('أدوات الذكاء الاصطناعي', `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">${tools.map(t => `<div onclick="handleAIRedirect('${t.u}')" class="glass-effect p-3 rounded-lg cursor-pointer hover:border-[var(--primary-glow)] transition border border-transparent"><h5 class="font-bold text-white">${t.n}</h5><p class="text-xs text-slate-400">${t.d}</p></div>`).join('')}</div>`);
            }
        }));
        
        window.handleAIRedirect = (url) => { openModalWithContent('جاري التحويل...', `<div class="text-center p-8"><p class="text-lg">سيتم تحويلك خلال 3 ثواني...</p><p class="mt-6 text-sm text-[var(--primary-glow)]">تطوير Amr lotfy</p></div>`); setTimeout(() => { window.open(url, '_blank'); document.getElementById('generic-modal').classList.remove('open'); }, 3000); };
        
        document.body.addEventListener('click', async e => {
            if (e.target.id === 'submit-opinion-btn') {
                const input = document.getElementById('opinion-input'); const text = input.value.trim();
                if (!text) { showToast('لا يمكن نشر رأي فارغ', true); return; }
                e.target.disabled = true; e.target.textContent = 'جارٍ النشر...';
                await addDoc(collection(db, "opinions"), { name: currentUser.name, year: currentUser.year, text, createdAt: serverTimestamp() });
                showToast('تم نشر رأيك بنجاح!'); input.value = ''; e.target.disabled = false; e.target.textContent = 'نشر الرأي';
            }
            if(e.target.classList.contains('theme-btn')) { document.documentElement.dataset.theme = e.target.dataset.theme; }
            if(e.target.id === 'logout-btn') { sessionStorage.removeItem('moraUser'); currentUser = null; location.reload(); }
            if(e.target.id === 'clear-data-btn') { if(confirm('هل أنت متأكد من محو بياناتك؟ سيتم تسجيل خروجك.')) { sessionStorage.removeItem('moraUser'); currentUser = null; location.reload(); }}
            if(e.target.id === 'rate-site-btn') { const container = document.getElementById('rating-container'); container.innerHTML = `<p class="text-center text-sm p-2 text-green-400">شكراً ${currentUser.name} لتقييمك!</p>`; }
            if(e.target.id === 'my-blog-btn') { openModalWithContent('مدونتي', '<p class="text-center p-4">هذه الميزة قيد التطوير حالياً.</p>'); }
        });

        window.addEventListener('load', () => { const savedUser = sessionStorage.getItem('moraUser'); if (savedUser) { currentUser = JSON.parse(savedUser); currentUser.isAdmin ? initAdminDashboard() : initStudentDashboard(); } else { showPage('landing-page'); } });
        document.getElementById('admin-logout-btn').addEventListener('click', () => { sessionStorage.removeItem('moraUser'); currentUser = null; location.reload(); });
        document.getElementById('generic-modal').addEventListener('click', e => { if (e.target.classList.contains('modal') || e.target.closest('.modal-close-btn')) document.getElementById('generic-modal').classList.remove('open'); });
    </script>
</body>
</html>

