<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="default">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mora For Studying - Final Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
        rel="stylesheet"
    />
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style id="theme-style-root">
        :root {
            --bg-color: #0d0d1a;
            --primary-glow: #00f5c3;
            --primary-glow-rgb: 0, 245, 195;
            --secondary-glow: #a78bfa;
            --secondary-glow-rgb: 167, 139, 250;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(0, 245, 195, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.37);
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
            transition: background-color 0.5s ease;
        }
        #app-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(at 20% 20%, var(--primary-glow) 0px, transparent 30%),
                radial-gradient(at 80% 80%, var(--secondary-glow) 0px, transparent 30%);
            animation: bg-pan 20s linear infinite alternate;
            opacity: 0.1;
            z-index: -1;
            will-change: transform;
        }
        @keyframes bg-pan {
            from { transform: scale(1) rotate(0deg); }
            to { transform: scale(1.2) rotate(45deg); }
        }
        @keyframes cinematic-enter {
            from { opacity: 0; transform: scale(1.1); filter: blur(8px); }
            to { opacity: 1; transform: scale(1); filter: blur(0); }
        }
        @keyframes page-enter {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes glowing-logo-pulse {
            0%, 100% { box-shadow: 0 0 25px var(--primary-glow), 0 0 50px var(--primary-glow); }
            50% { box-shadow: 0 0 35px var(--secondary-glow), 0 0 70px var(--secondary-glow); }
        }
        @keyframes scroll-text-rtl {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }
        @keyframes unlocked-3d-float {
            0% { transform: translateY(0) rotateY(0deg) scale(1); opacity: 0.8; }
            50% { transform: translateY(-5px) rotateY(180deg) scale(1.1); opacity: 1; }
            100% { transform: translateY(0) rotateY(360deg) scale(1); opacity: 0.8; }
        }
        @keyframes loading-bar {
            from { width: 0%; }
            to { width: 100%; }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 5px 10px rgba(255, 0, 0, 0); }
        }
        @keyframes icon-3d-float {
            0% { transform: translate(0, 0) rotateY(0deg) scale(1); }
            25% { transform: translate(5px, -5px) rotateY(15deg) scale(1.1); }
            50% { transform: translate(-5px, 0) rotateY(0deg) scale(1); }
            75% { transform: translate(0, 5px) rotateY(-15deg) scale(1.1); }
            100% { transform: translate(0, 0) rotateY(0deg) scale(1); }
        }
        @keyframes notification-bell {
            0% { transform: rotate(0deg); }
            10% { transform: rotate(14deg); }
            20% { transform: rotate(-8deg); }
            30% { transform: rotate(14deg); }
            40% { transform: rotate(-4deg); }
            50% { transform: rotate(10deg); }
            60% { transform: rotate(0deg); }
            100% { transform: rotate(0deg); }
        }
        .live-pulse { animation: pulse 1.5s infinite; }
        .unlocked-icon-3d { animation: unlocked-3d-float 5s infinite ease-in-out; display: inline-block; }
        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            opacity: 0;
            animation: page-enter 0.3s ease-out forwards;
            will-change: transform, opacity;
        }
        .page.active { display: flex; flex-direction: column; }
        #auth-page { z-index: 10; }
        #auth-page.active, #splash-screen.active {
            animation: cinematic-enter 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        #auth-form-container {
            max-height: 100vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-glow) transparent;
        }
        .glass-effect {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
        }
        .glowing-logo {
            animation: glowing-logo-pulse 4s infinite ease-in-out;
            will-change: box-shadow;
        }
        .input-field, .select-field {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 0.65rem 1rem;
        }
        .input-field:focus, .select-field:focus {
            background: rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 15px var(--primary-glow);
            border-color: var(--primary-glow);
            outline: none;
        }
        .input-field::placeholder { color: var(--text-secondary); }
        .btn-celestial {
            background: transparent;
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            text-shadow: 0 0 10px var(--primary-glow);
            box-shadow: 0 0 15px var(--primary-glow) inset, 0 0 5px var(--primary-glow);
            transition: all 0.3s ease;
        }
        .btn-celestial:hover:not(:disabled) {
            background: var(--primary-glow);
            color: var(--bg-color);
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--primary-glow) inset, 0 0 20px var(--primary-glow);
            text-shadow: none;
        }
        .btn-celestial:active:not(:disabled) {
            transform: scale(0.98);
            box-shadow: 0 0 10px var(--primary-glow) inset;
        }
        .btn-celestial:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .scrolling-banner {
            transition: transform 0.5s ease;
            font-size: 0.7rem !important;
        }
        .bottom-nav {
            transition: transform 0.5s ease;
            overflow-x: auto;
            flex-wrap: nowrap;
            padding-bottom: 8px;
            justify-content: flex-start;
        }
        .bottom-nav::-webkit-scrollbar { display: none; }
        .bottom-nav { scrollbar-width: none; -ms-overflow-style: none; }
        .bottom-nav-btn { flex-shrink: 0; position: relative; }
        body.focus-mode .scrolling-banner { transform: translateY(-100%); }
        @media (min-width: 640px) {
            body.focus-mode .bottom-nav { transform: translateY(100%); }
        }
        @media (max-width: 639px) {
            body.focus-mode .bottom-nav { transform: translateY(0); }
        }
        body.focus-mode #exit-focus-mode-btn { display: flex; }
        body.focus-mode #ai-avatar-container { display: none; }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 8px;
            background-color: #f43f5e;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 1px solid var(--bg-color);
        }
        .scrolling-banner p {
            display: inline-block;
            padding: 4px 0;
            font-size: 0.7rem;
            animation: scroll-text-rtl 25s linear infinite;
            color: var(--primary-glow);
            text-shadow: 0 0 8px var(--primary-glow);
            font-weight: 600;
        }
        .bottom-nav-btn i {
            filter: drop-shadow(0 0 5px var(--primary-glow));
            transition: all 0.3s ease;
        }
        .bottom-nav-btn:hover i {
            filter: drop-shadow(0 0 15px var(--primary-glow));
            transform: scale(1.1) translateY(-2px);
            color: var(--primary-glow);
        }
        .modal { display: none; }
        .modal.open { display: flex; }
        #modal-body { scrollbar-width: thin; scrollbar-color: var(--primary-glow) transparent; }
        .social-icon-animated {
            animation: icon-3d-float 6s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        .social-icon-animated:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 0 8px var(--glow-color));
            animation-play-state: paused;
        }
        .live-indicator {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .notification-indicator {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 8px;
            background-color: #f43f5e;
            border-radius: 50%;
        }
        .admin-nav-btn {
            position: relative;
            transition: all 0.2s ease-in-out;
            border-right: 3px solid transparent;
        }
        .admin-nav-btn:hover:not(.active) {
            transform: translateX(5px);
            background-color: rgba(var(--primary-glow-rgb), 0.1);
            border-right-color: var(--primary-glow);
        }
        .admin-nav-btn.active {
            background-color: var(--primary-glow);
            color: var(--bg-color);
            font-weight: bold;
            transform: translateX(5px);
        }
        .admin-panel { animation: fade-in-up 0.5s ease forwards; }
        #admin-dashboard .glass-effect {
            animation: fade-in-up 0.5s ease-out backwards;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 1px solid var(--glass-border);
        }
        #admin-dashboard .glass-effect:hover {
            transform: translateY(-6px) scale(1.02);
            border-color: rgba(var(--primary-glow-rgb), 0.5);
            box-shadow: 0 0 25px rgba(var(--primary-glow-rgb), 0.3),
                0 10px 40px 0 var(--shadow-color);
        }
        .subject-card {
            background-color: rgba(16, 26, 42, 0.75);
            border: 1px solid rgba(var(--primary-glow-rgb), 0.5);
            box-shadow: 0 0 15px rgba(var(--primary-glow-rgb), 0.2);
            transition: all 0.3s ease-out;
        }
        .subject-card:hover {
            transform: translateY(-6px) scale(1.03);
            border-color: rgba(var(--primary-glow-rgb), 1);
            box-shadow: 0 0 25px rgba(var(--primary-glow-rgb), 0.5);
        }
        .footer-text {
            display: none;
        }
        #privacy-rating-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        #privacy-rating-content {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            color: var(--text-primary);
        }
        #privacy-rating-content h3 {
            color: var(--primary-glow);
            text-align: center;
            margin-bottom: 1rem;
        }
        #privacy-rating-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        #privacy-rating-content strong {
            color: var(--secondary-glow);
        }
        #privacy-rating-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        #privacy-rating-buttons button {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        #agree-btn {
            background: var(--primary-glow);
            color: var(--bg-color);
        }
        .course-actions, .book-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .course-btn, .book-btn {
            flex: 1;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            border-radius: 0.375rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .watch-btn {
            background: var(--primary-glow);
            color: var(--bg-color);
        }
        .download-btn {
            background: #4f46e5;
            color: white;
        }
        .watch-btn:hover {
            background: #00d1a0;
        }
        .download-btn:hover {
            background: #4338ca;
        }
        .redirect-modal-icon {
            animation: unlocked-3d-float 4s infinite ease-in-out;
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        /* Meeting button live indicator */
        .meeting-live-indicator {
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .meeting-live-dot {
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .meeting-live-text {
            font-size: 0.65rem;
            font-weight: bold;
            color: red;
            white-space: nowrap;
        }
        /* Polls WhatsApp-like style */
        .poll-item {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }
        .poll-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .poll-author {
            font-weight: bold;
            color: var(--primary-glow);
        }
        .poll-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .poll-body {
            margin: 6px 0;
            line-height: 1.5;
        }
        .poll-replies {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .reply-item {
            background: rgba(55, 65, 81, 0.5);
            padding: 6px 10px;
            border-radius: 10px;
            margin-top: 6px;
            font-size: 0.9rem;
        }
        .reply-author {
            font-size: 0.75rem;
            color: var(--secondary-glow);
            margin-top: 2px;
        }
        /* Onboarding Modal - بدون زر تخطي */
        #onboarding-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        #onboarding-content {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            color: var(--text-primary);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        #onboarding-icon {
            font-size: 3rem;
            margin: 1rem 0;
            color: var(--primary-glow);
            animation: icon-3d-float 4s infinite ease-in-out;
        }
        #onboarding-text {
            margin: 1rem 0;
            line-height: 1.6;
        }
        #onboarding-buttons {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }
        #onboarding-next-btn {
            padding: 0.5rem 1.5rem;
            background: var(--primary-glow);
            color: var(--bg-color);
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        /* App Downloads Section */
        .download-item {
            background: rgba(30, 41, 59, 0.6);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .download-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        /* === LIVE ATTENDANCE BANNER === */
        #live-attendance-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #dc2626;
            color: white;
            text-align: center;
            padding: 8px 0;
            font-weight: bold;
            z-index: 100;
            display: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #live-attendance-banner:hover {
            background: #ef4444;
        }
        /* === CONTENT POLICY NOTICE === */
        .content-policy-notice {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            color: #fca5a5;
        }
        .content-policy-notice strong {
            color: #fecaca;
        }
        /* === Lecture Content Styling === */
        .lecture-content {
            line-height: 1.8;
            color: #cbd5e1;
            font-size: 1.05rem;
        }
        .lecture-content h1,
        .lecture-content h2,
        .lecture-content h3 {
            color: #60a5fa;
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            font-weight: 700;
        }
        .lecture-content p {
            margin-bottom: 1rem;
            color: #e2e8f0;
        }
        .lecture-content strong {
            color: #93c5fd;
        }
        .lecture-content em {
            color: #bae6fd;
            font-style: italic;
        }
        .lecture-content ul,
        .lecture-content ol {
            padding-right: 1.5rem;
            margin-bottom: 1rem;
        }
        .lecture-content li {
            margin-bottom: 0.4rem;
        }
        .lecture-content code {
            background: rgba(30, 41, 59, 0.6);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #a7f3d0;
        }
        .lecture-content blockquote {
            border-right: 3px solid var(--primary-glow);
            padding-right: 1rem;
            margin: 1.2rem 0;
            color: #94a3b8;
            font-style: italic;
        }

        /* === AI Avatar Container === */
        #ai-avatar-container {
            position: fixed;
            top: 12px;
            right: 12px;
            width: 60px;
            height: 60px;
            z-index: 100;
            pointer-events: none;
        }
        #ai-avatar-canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0, 245, 195, 0.6);
        }
        #ai-avatar-message {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: var(--primary-glow);
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            white-space: nowrap;
            margin-bottom: 8px;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s, transform 0.4s;
        }
        #ai-avatar-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* === Focus Mode Toggle Button === */
        #focus-mode-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary-glow);
            color: var(--primary-glow);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(8px);
        }
        #focus-mode-btn:hover {
            background: rgba(0, 245, 195, 0.2);
            transform: scale(1.1);
        }
        #focus-mode-btn i {
            font-size: 1.2rem;
        }
    </style>
</head>
<body class="w-full h-screen">
    <div id="app-bg"></div>
    <!-- Live Attendance Banner -->
    <div id="live-attendance-banner" onclick="handleLiveAttendanceBannerClick()">
        🎓 اضغط هنا للدخول وحضور المحاضرة مباشرة!
    </div>
    <!-- AI Avatar -->
    <div id="ai-avatar-container" class="hidden">
        <canvas id="ai-avatar-canvas"></canvas>
        <div id="ai-avatar-message"></div>
    </div>
    <div id="app-container" class="w-full h-full relative">
        <!-- Auth Page -->
        <div id="auth-page" class="page justify-center items-end p-4">
            <div id="auth-form-container" class="w-full h-full flex justify-center items-end p-4"></div>
        </div>
        <!-- Privacy Modal -->
        <div id="privacy-rating-modal">
            <div id="privacy-rating-content">
                <h3>سياسة الخصوصية</h3>
                <div id="privacy-text">
                    <p><strong>مقدمة:</strong> نحن في منصة "Mora For Studying" نأخذ خصوصية بياناتك على محمل الجد.</p>
                    <p><strong>البيانات التي نجمعها:</strong> عند إنشاء حساب، نقوم بجمع الاسم، الفرقة، الشعبة، بالإضافة إلى IP Address ونوع الجهاز لأغراض أمنية وتحليلية.</p>
                    <p><strong>استخدام البيانات:</strong> لا يتم مشاركة بياناتك الشخصية مع أي طرف ثالث. تُستخدم البيانات داخليًا لتحسين تجربتك وتأمين المنصة.</p>
                    <p class="font-bold text-red-400 border-t border-red-500/30 pt-3 mt-3">
                        <strong>سياسة الاستخدام العادل:</strong> أي محاولة لإساءة استخدام الموقع، أو نشر محتوى غير لائق، أو التحايل على نظام النقاط سيؤدي إلى <strong>الحظر الفوري والدائم للحساب</strong> دون سابق إنذار.
                    </p>
                </div>
                <div id="privacy-rating-buttons">
                    <button id="agree-btn">موافق</button>
                </div>
            </div>
        </div>
        <!-- Onboarding Modal - بدون زر تخطي -->
        <div id="onboarding-modal">
            <div id="onboarding-content">
                <div id="onboarding-icon"><i class="ph-identification-card"></i></div>
                <h3 id="onboarding-title">مرحباً بك في Mora!</h3>
                <p id="onboarding-text">استعد لرحلة تعليمية ممتعة وسهلة مع أفضل الميزات التفاعلية!</p>
                <div id="onboarding-buttons">
                    <button id="onboarding-next-btn">التالي</button>
                </div>
                <div class="absolute -top-4 -right-4 text-5xl animate-bounce">✨</div>
                <div class="absolute -bottom-4 -left-4 text-4xl animate-pulse">📚</div>
            </div>
        </div>
        <!-- Splash Screen -->
        <div id="splash-screen" class="page justify-center items-center p-4 text-center">
            <p id="splash-text" data-text-key="splashScreenMessage" class="text-xl font-semibold mb-8 tracking-wider text-shadow" style="color:var(--primary-glow)"></p>
            <div class="w-40 h-1 bg-[var(--glass-border)] rounded-full"><div class="h-full bg-[var(--primary-glow)] rounded-full animate-[loading-bar_1s_linear_forwards]"></div></div>
        </div>
        <!-- Student Dashboard -->
        <div id="student-dashboard" class="page h-screen w-screen overflow-hidden">
            <div class="scrolling-banner absolute top-0 left-0 w-full bg-slate-900/50 backdrop-blur-sm whitespace-nowrap overflow-hidden shadow-lg z-50"><p data-text-key="scrollingBannerText"></p></div>
            <header class="p-4 flex justify-between items-center mt-2">
                <div class="flex items-center gap-4">
                    <div id="logo-container" class="relative">
                        <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="Logo" class="w-12 h-12 rounded-full glowing-logo" loading="lazy" decoding="async">
                        <div id="timer-live-indicator" class="hidden absolute -top-1 -right-2 flex items-center gap-1.5 bg-red-600/80 backdrop-blur-sm text-white px-2 py-0.5 rounded-full text-xs font-bold border border-red-400">
                            <div class="w-2 h-2 bg-white rounded-full live-pulse"></div>
                            <span>تركيز</span>
                        </div>
                    </div>
                    <button id="notifications-bell" class="relative text-2xl text-slate-300 hover:text-[var(--primary-glow)] transition">
                        <i class="ph-bell"></i>
                        <div id="notification-dot" class="notification-indicator hidden"></div>
                    </button>
                </div>
                <div class="text-right">
                    <h2 id="welcome-name" class="font-bold text-lg">مرحباً يا ...</h2>
                    <p id="user-details" class="text-xs text-slate-400 mt-1">...</p>
                    <p id="student-id" class="text-xs text-slate-500 mt-1 font-mono"></p>
                </div>
            </header>
            <main class="flex-grow p-4 overflow-y-auto pb-32">
                <div id="materials-list" class="space-y-4 max-w-md mx-auto"></div>
            </main>
            <footer class="fixed bottom-[64px] sm:bottom-[60px] left-0 w-full p-2 text-center text-xs pointer-events-none z-40">
                <p class="footer-text" data-text-key="footerText"></p>
            </footer>
            <nav class="bottom-nav fixed bottom-0 right-0 left-0 glass-effect flex text-xs z-50 p-1">
                <button onclick="showSubjectSelectionModal('books')" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-books text-xl"></i><span>كتب</span></button>
                <button onclick="showSubjectSelectionModal('sections')" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-stack-simple text-xl"></i><span>سكاشن</span></button>
                <button id="courses-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-cube unlocked-icon-3d text-xl"></i><span>كورسات</span></button>
                <button data-modal="ai-tools-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-robot text-xl"></i><span>أدوات AI</span></button>
                <button data-modal="opinions-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-chats-teardrop text-xl"></i><span>آراء</span></button>
                <!-- Polls Button -->
                <button data-modal="polls-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-megaphone-simple text-xl"></i><span>استطلاعات</span></button>
                <!-- Meeting Button -->
                <button id="meeting-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2 relative">
                    <i class="ph-video text-xl"></i>
                    <span>ميتنج</span>
                    <div id="meeting-live-indicator" class="meeting-live-indicator hidden">
                        <div class="meeting-live-dot"></div>
                        <span class="meeting-live-text">مباشر</span>
                    </div>
                </button>
                <button id="digital-card-nav-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-identification-card text-xl"></i><span>بطاقتي</span></button>
                <!-- ✅ Summary Button -->
                <button id="summary-nav-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-notebook text-xl"></i><span>تلخيص</span></button>
                <button id="privacy-policy-nav-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-shield-check text-xl"></i><span>الخصوصية</span></button>
                <button data-modal="support-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-headset text-xl"></i><span>الدعم</span></button>
                <button data-modal="about-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-info text-xl"></i><span>عنا</span></button>
                <button id="platform-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-globe-hemisphere-west text-xl"></i><span>المنصة</span></button>
                <button id="study-timer-nav-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-timer text-xl"></i><span>تايمر</span></button>
                <button data-modal="settings-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-gear-six text-xl"></i><span>الإعدادات</span></button>
                <button id="account-options-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i class="ph-user-circle text-xl"></i><span>حسابي</span></button>
            </nav>
        </div>
        <!-- Subject Content Page -->
        <div id="subject-content-page" class="page h-screen w-screen overflow-hidden"></div>
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="page h-screen w-screen overflow-hidden">
             <div class="flex flex-col lg:flex-row h-full">
                <aside class="w-full lg:w-72 glass-effect p-4 flex flex-col flex-shrink-0">
                  <h1 class="text-2xl font-bold text-[var(--primary-glow)] mb-8">لوحة التحكم</h1>
                  <nav class="flex-grow flex flex-col space-y-2 overflow-y-auto">
                        <button data-panel="info-panel" class="admin-nav-btn text-right p-3 rounded-lg">لوحة المعلومات</button>
                        <button data-panel="students-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة الطلاب</button>
                        <button data-panel="tickets-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة الشكاوى</button>
                        <button data-panel="live-stream-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة البث المباشر</button>
                        <button data-panel="content-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة المحتوى</button>
                        <button data-panel="text-management-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة النصوص</button>
                        <button data-panel="notifications-panel" class="admin-nav-btn text-right p-3 rounded-lg">الإشعارات</button>
                        <!-- ✅ NEW: Courses Panel -->
                        <button data-panel="courses-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة الكورسات</button>
                        <button data-panel="ai-tools-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة أدوات AI</button>
                        <button data-panel="opinions-panel" class="admin-nav-btn text-right p-3 rounded-lg">آراء الطلاب</button>
                        <button data-panel="polls-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة الاستطلاعات</button>
                        <button data-panel="settings-panel" class="admin-nav-btn text-right p-3 rounded-lg">إعدادات الموقع</button>
                        <!-- ✅ NEW: Attendance Panel -->
                        <button data-panel="attendance-panel" class="admin-nav-btn text-right p-3 rounded-lg">تسجيل الحضور</button>
                  </nav>
                  <div class="mt-auto flex-shrink-0 pt-4">
                        <button id="admin-logout-btn" class="w-full py-2 rounded-lg text-lg font-bold btn-celestial border-red-500 text-red-500 hover:bg-red-500 hover:text-white">خروج</button>
                  </div>
                </aside>
                <main class="flex-grow p-4 md:p-8 overflow-y-auto">
                    <div id="info-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">لوحة المعلومات</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 text-center">
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.1s;"><h3 class="text-lg text-slate-400">إجمالي الطلاب</h3><p id="admin-student-count" class="text-4xl font-bold text-[var(--primary-glow)] mt-2 transition-all">0</p></div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.2s;"><h3 class="text-lg text-slate-400">إجمالي الآراء</h3><p id="admin-opinions-count" class="text-4xl font-bold text-[var(--secondary-glow)] mt-2 transition-all">0</p></div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.3s;"><h3 class="text-lg text-slate-400">إجمالي الاستطلاعات</h3><p id="admin-polls-count" class="text-4xl font-bold text-cyan-400 mt-2 transition-all">0</p></div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.4s;"><h3 class="text-lg text-slate-400">إجمالي التقييمات</h3><p id="admin-ratings-count" class="text-4xl font-bold text-yellow-400 mt-2 transition-all">0</p></div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.5s;"><h3 class="text-lg text-slate-400">إجمالي الإشعارات</h3><p id="admin-notifications-count" class="text-4xl font-bold text-rose-400 mt-2 transition-all">0</p></div>
                            <!-- قسم تحميل التطبيق -->
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.6s;">
                                <h3 class="text-lg text-slate-400">تنزيلات التطبيق</h3>
                                <p id="app-downloads-count" class="text-4xl font-bold text-purple-400 mt-2 transition-all">0</p>
                                <button id="view-downloads-btn" class="mt-3 py-1.5 px-4 rounded-lg text-sm font-bold btn-celestial">عرض التنزيلات</button>
                            </div>
                        </div>
                    </div>
                    <!-- باقي الألواح كما هي -->
                    <div id="live-stream-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة البث المباشر</h2>
                        <div class="space-y-6 max-w-2xl">
                            <div class="glass-effect p-6 rounded-lg">
                                <h3 class="font-bold text-lg mb-2 text-slate-300">الخطوة 1: ضع رابط البث الأساسي (مرة واحدة فقط)</h3>
                                <p class="text-xs text-slate-500 mb-4">ضع هنا رابط جوجل ميت الدائم الذي ستستخدمه في كل محاضراتك.</p>
                                <div class="flex gap-3">
                                    <input type="url" id="meet-link-input" placeholder="https://meet.google.com/xyz-abcd-efg" class="w-full rounded-lg input-field">
                                    <button id="save-meet-link-btn" class="py-2 px-6 rounded-lg font-bold btn-celestial flex-shrink-0">حفظ</button>
                                </div>
                            </div>
                            <div class="glass-effect p-6 rounded-lg text-center">
                                <h3 class="font-bold text-lg mb-2 text-slate-300">الخطوة 2: تحكم في البث المباشر</h3>
                                <p class="text-sm text-slate-400 mb-4">استخدم هذه الأزرار لبدء وإنهاء ظهور إشعار الدخول عند الطلاب.</p>
                                <div class="flex justify-center items-center gap-3 mb-4">
                                    <p class="text-slate-300">الحالة الحالية:</p>
                                    <span id="stream-status-indicator" class="px-3 py-1 rounded-full text-sm font-bold"></span>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <button id="start-stream-btn" class="py-3 rounded-lg font-bold text-lg bg-green-600 text-white hover:bg-green-500 transition shadow-lg shadow-green-500/20 disabled:bg-slate-600 disabled:cursor-not-allowed">🚀 بدء البث الآن</button>
                                    <button id="end-stream-btn" class="py-3 rounded-lg font-bold text-lg bg-red-600 text-white hover:bg-red-500 transition shadow-lg shadow-red-500/20 disabled:bg-slate-600 disabled:cursor-not-allowed">⏹️ إنهاء البث الآن</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ✅ NEW: Attendance Panel -->
                    <div id="attendance-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">سجل الحضور</h2>
                        <div id="attendance-list" class="space-y-4">
                            <p class="text-center text-slate-400">جارٍ تحميل سجل الحضور...</p>
                        </div>
                    </div>
                    <!-- باقي الألواح كما هي -->
                    <div id="tickets-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة الشكاوى والدعم الفني</h2>
                        <div id="admin-tickets-list" class="space-y-4"></div>
                    </div>
                    <div id="students-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">إدارة الطلاب</h2><div id="admin-students-list" class="space-y-4"></div></div>
                    <div id="content-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">إدارة المحتوى</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div><div class="glass-effect p-6 rounded-lg"><h3 id="content-form-title" class="text-xl font-bold mb-4">إضافة محتوى جديد</h3><select id="content-type-select" class="w-full rounded-lg select-field appearance-none mb-4"><option value="lectures">محاضرة</option><option value="books">كتاب</option><option value="sections">سكشن</option></select><select id="content-year-select" class="w-full rounded-lg select-field appearance-none mb-4"><option value="">اختر الفرقة</option><option value="1">الأولى</option><option value="2">الثانية</option></select><select id="content-division-select" class="w-full rounded-lg select-field appearance-none mb-4"><option value="">اختر الشعبة</option><option value="international">أعمال دولية</option><option value="systems">نظم معلومات</option></select><select id="content-subject-select" class="w-full rounded-lg select-field appearance-none mb-4"><option value="">اختر المادة أولاً</option></select><input id="content-title-input" type="text" placeholder="عنوان المحتوى" class="w-full rounded-lg input-field mb-4"><textarea id="content-body-input" placeholder="نص المحتوى أو الرابط..." class="w-full rounded-lg input-field mb-4" rows="4"></textarea><div class="flex gap-4"><button id="save-content-btn" class="w-full py-2 rounded-lg text-sm font-bold btn-celestial">حفظ</button><button id="cancel-edit-btn" class="w-full py-2 rounded-lg text-sm font-bold btn-celestial border-yellow-500 text-yellow-500 hover:bg-yellow-500 hover:text-black hidden">إلغاء التعديل</button></div></div></div><div><h3 class="text-xl font-bold mb-4">المحتوى المضاف حاليًا</h3><div id="admin-content-list" class="space-y-3"></div></div></div></div>
                    <div id="text-management-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة نصوص الموقع</h2>
                        <div id="text-management-form" class="space-y-4"></div>
                        <button id="save-texts-btn" class="w-full max-w-sm mt-6 py-2.5 rounded-lg text-base font-bold btn-celestial">حفظ كل التغييرات</button>
                    </div>
                    <div id="notifications-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">إدارة الإشعارات</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div><div class="glass-effect p-6 rounded-lg"><h3 class="text-xl font-bold mb-4">إرسال إشعار جديد</h3><input id="notification-title-input" type="text" placeholder="عنوان الإشعار (اختياري)" class="w-full rounded-lg input-field mb-4"><textarea id="notification-body-input" placeholder="نص الإشعار..." class="w-full rounded-lg input-field mb-4" rows="4"></textarea><button id="send-notification-btn" class="w-full py-2 rounded-lg text-sm font-bold btn-celestial">إرسال</button></div></div><div><h3 class="text-xl font-bold mb-4">الإشعارات المرسلة</h3><div id="admin-notifications-list" class="space-y-3"></div></div></div></div>
                    <!-- ✅ COURSES PANEL (CATEGORIZED) -->
                    <div id="courses-panel" class="admin-panel hidden">
                         <h2 class="text-3xl font-bold mb-6">إدارة الكورسات</h2>
                         <div class="glass-effect p-6 rounded-lg mb-6">
                            <h3 class="font-bold mb-4">إضافة فئة كورس جديدة</h3>
                            <input id="course-category-input" type="text" placeholder="اسم الفئة (مثال: المونتاج)" class="w-full rounded-lg input-field mb-4">
                            <button id="add-course-category-btn" class="w-full py-2 rounded-lg font-bold btn-celestial">إضافة فئة</button>
                            <hr class="my-4 border-slate-700/50">
                            <h3 class="font-bold mb-4">إضافة كورس جديد</h3>
                            <select id="course-category-select" class="w-full rounded-lg select-field appearance-none mb-4">
                                <option value="">اختر الفئة</option>
                            </select>
                            <input id="course-title-input" type="text" placeholder="عنوان الكورس" class="w-full rounded-lg input-field mb-4">
                            <textarea id="course-desc-input" placeholder="وصف الكورس" class="w-full rounded-lg input-field mb-4" rows="3"></textarea>
                            <input id="course-url-input" type="text" placeholder="رابط فيديو يوتيوب" class="w-full rounded-lg input-field mb-4">
                            <button id="add-course-btn" class="w-full py-2 rounded-lg font-bold btn-celestial">إضافة الكورس</button>
                         </div>
                         <div id="admin-courses-list" class="space-y-4"></div>
                    </div>
                    <div id="ai-tools-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">إدارة أدوات AI</h2><div class="glass-effect p-6 rounded-lg mb-6"><h3 class="font-bold mb-4">إضافة أداة جديدة</h3><input id="ai-name-input" type="text" placeholder="اسم الأداة" class="w-full rounded-lg input-field mb-4"><input id="ai-desc-input" type="text" placeholder="وصف الأداة" class="w-full rounded-lg input-field mb-4"><input id="ai-url-input" type="text" placeholder="رابط الأداة" class="w-full rounded-lg input-field mb-4"><button id="add-ai-tool-btn" class="w-full py-2 rounded-lg font-bold btn-celestial">إضافة الأداة</button></div><div id="admin-ai-tools-list" class="space-y-4"></div></div>
                    <div id="opinions-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">آراء الطلاب</h2><div id="admin-opinions-list" class="space-y-4"></div></div>
                    <div id="polls-panel" class="admin-panel hidden"><h2 class="text-3xl font-bold mb-6">إدارة الاستطلاعات</h2><div id="admin-polls-list" class="space-y-4"></div></div>
                    <div id="settings-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إعدادات الموقع</h2>
                        <div class="space-y-4 max-w-2xl">
                            <div class="glass-effect p-6 rounded-lg space-y-4">
                                <label class="flex items-center justify-between cursor-pointer"><span class="font-bold">تفعيل قسم الكورسات (أساسي)</span><input type="checkbox" id="courses-toggle" class="form-checkbox h-5 w-5 text-[var(--primary-glow)] rounded" checked disabled></label>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    <!-- Generic Modal -->
    <div id="generic-modal" class="modal fixed inset-0 bg-black/70 backdrop-blur-md z-[1000] justify-center items-center p-4">
        <div class="modal-content glass-effect w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 rounded-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 id="modal-title" class="text-2xl font-bold text-[var(--primary-glow)]"></h3>
                <button class="modal-close-btn text-3xl hover:text-red-500 transition">×</button>
            </div>
            <div id="modal-body" class="overflow-y-auto flex-grow"></div>
        </div>
    </div>
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-5 right-5 glass-effect p-4 rounded-lg shadow-lg z-[2000] opacity-0 -translate-y-12 transition-all duration-500">
        <p id="toast-message"></p>
    </div>
    <!-- Exit Focus Mode Button -->
    <button id="exit-focus-mode-btn" class="fixed bottom-4 right-4 z-[100] hidden h-14 w-14 items-center justify-center rounded-full bg-slate-800/50 text-white shadow-lg backdrop-blur-md transition-transform hover:scale-110 active:scale-95">
        <i class="ph-gear-six text-2xl"></i>
    </button>
    <!-- Audio Container -->
    <div id="audio-container" class="hidden">
        <audio id="register-sound" src="https://code-gemini.github.io/Mora-For-Studying/register.mp3" preload="auto"></audio>
        <audio id="timer-start-sound" src="https://code-gemini.github.io/Mora-For-Studying/timer-start.mp3" preload="auto"></audio>
        <audio id="timer-end-sound" src="https://code-gemini.github.io/Mora-For-Studying/timer-end.mp3" preload="auto"></audio>
        <audio id="admin-notification-sound" src="https://code-gemini.github.io/Mora-For-Studying/notification.mp3" preload="auto"></audio>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDocs, query, where, onSnapshot, deleteDoc, updateDoc, orderBy, serverTimestamp, getDoc, setDoc, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyB92ooyA5_tTx1BLDp2EWmqxHuJQ3zqah4", authDomain: "mora-for-studying.firebaseapp.com", projectId: "mora-for-studying", storageBucket: "mora-for-studying.appspot.com", messagingSenderId: "213416531900", appId: "1:213416531900:web:2e4d8bd2a9e1a4e814bdb9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentUser = null;
        let vantaEffect = null;
        let currentEditState = { id: null, collection: null };
        let currentContentUnsubscribe = null;
        let siteSettings = {};
        let siteTexts = {};
        const badWords = [
            "كلب", "خرا", "متناك", "معرص", "خول", "شرموطة", "كس", "زب", "عير", "قحبة", "ابن الوسخة",
            "عاهرة", "زنا", "لعين", "حقير", "وضيع", "سافل", "شاذ", "شاذة", "عاهر", "زانية", "عاهرات",
            "فاسق", "فاسقة", "منحرف", "منحرفة", "ساقطة", "ساقط", "عاهر", "عاهره", "عاهرة", "عاهرات", "عاهر", "عاهره", "عاهرة",
            "ابن وسخه", "ابن وسخة", "ولد وسخ", "بنت وسخة", "وسخ", "وسخه", "وسخة", "هنيكك", "كسمك", "ابن مىه"
        ];
        const defaultTexts = {
            splashScreenMessage: "متنساش تصلي على النبي ﷺ",
            scrollingBannerText: "شكر خاص لإدارة المعهد وأعضاء هيئة التدريس في تطوير هذا الموقع التعليمي ***",
            footerText: "جميع الحقوق محفوظة © Amr lotfy 2025",
            coursesLockedToast: "الكورسات متاحة للجميع الآن!",
            meetingLockedToast: "سوف يتم فتح هذا القسم عند شرح المواد اونلاين",
            pointsInfo_0: "الكورسات مفتوحة للجميع!",
            pointsInfo_other: "الكورسات مفتوحة للجميع!",
            pointsInfo_unlocked: "الكورسات مفتوحة للجميع!",
            addPointsToast: "تمت إضافة 25 نقطة! ✨",
            aboutMain: "هذا الموقع خاص بالفرقة الأولى والثانية لطلاب المعهد العالي للحاسبات والمعلومات بطنطا.",
            aboutDeveloper: "تطوير Amr lotfy",
            aboutSupervisors: "تحت رعاية"
        };
        const textLabels = {
            splashScreenMessage: "رسالة شاشة البداية", scrollingBannerText: "الشريط الإخباري المتحرك", footerText: "جملة الحقوق المحفوظة", coursesLockedToast: "رسالة قفل قسم الكورسات", meetingLockedToast: "رسالة قفل قسم الميتنج", pointsInfo_0: "رسالة النقاط (عندما تكون صفر)", pointsInfo_other: "رسالة النقاط (عندما تكون أكبر من صفر)", pointsInfo_unlocked: "رسالة النقاط (بعد فتح الكورسات)", addPointsToast: "رسالة إضافة النقاط", aboutMain: "فقرة 'عنا' الرئيسية", aboutDeveloper: "جملة المطور", aboutSupervisors: "عنوان 'تحت رعاية'"
        };
        const materials = {
            ar: { '1_international': [ 'مبادئ المحاسبة الماليه', 'مبادئ الاقتصاد', 'مبادئ القانون', 'لغه اجنبيه (1)', 'مبادئ اداره الاعمال' ], '1_systems': ['طرق ومهارات الاتصال', 'رياضيات الاعمال', 'حقوق الانسان', 'التفكير الابتكاري', 'السلوك التنظيمي', 'اساسيات الحاسب وتكتولوچيا المعلومات'], '2_international': ['اداره اللوچيستيات وسلاسل الامداد', 'مبادئ التسويق', 'مبادئ الاقتصاد الجزئي', 'محاسبه التكاليف', 'قانون الاعمال'], '2_systems': ['قانون الاعمال', 'قواعد البيانات (1)', 'اداره الانتاج', 'محاسبه الشركات', 'تصميم برامج الحاسب'] },
        };
        const onboardingSteps = [
            { icon: 'ph-books', title: 'الكتب', text: 'استعرض الكتب الدراسية الخاصة بمادتك.' },
            { icon: 'ph-stack-simple', title: 'السكاشن', text: 'شاهد شرح السكاشن من المحاضرات.' },
            { icon: 'ph-cube', title: 'الكورسات', text: 'تعلم من كورسات مجانية متنوعة.' },
            { icon: 'ph-robot', title: 'أدوات الذكاء الاصطناعي', text: 'استخدم أدوات ذكاء اصطناعي مساعدة.' },
            { icon: 'ph-chats-teardrop', title: 'آراء الطلاب', text: 'شارك رأيك أو اقرأ آراء زملائك.' },
            { icon: 'ph-megaphone-simple', title: 'استطلاعات', text: 'شارك في استطلاعات الرأي والمناقشات.' },
            { icon: 'ph-video', title: 'ميتنج', text: 'انضم إلى البث المباشر للمحاضرات.' },
            { icon: 'ph-identification-card', title: 'بطاقتي', text: 'عرض بطاقتك الرقمية مع رمز QR.' },
            { icon: 'ph-shield-check', title: 'الخصوصية', text: 'اقرأ سياسة الخصوصية الخاصة بالموقع.' },
            { icon: 'ph-headset', title: 'الدعم', text: 'تواصل مع فريق الدعم الفني.' },
            { icon: 'ph-info', title: 'عنا', text: 'تعرف على فريق التطوير والمشرفين.' },
            { icon: 'ph-globe-hemisphere-west', title: 'المنصة', text: 'الانتقال إلى المنصة الرسمية للمعهد.' },
            { icon: 'ph-timer', title: 'تايمر', text: 'استخدم تايمر المذاكرة لتحسين تركيزك.' },
            { icon: 'ph-gear-six', title: 'الإعدادات', text: 'غيّر الثيم أو الإعدادات الأخرى.' },
            { icon: 'ph-user-circle', title: 'حسابي', text: 'إدارة حسابك أو تسجيل الخروج.' }
        ];
        const studentDashboardEl = { welcomeName: document.getElementById('welcome-name'), userDetails: document.getElementById('user-details'), studentId: document.getElementById('student-id'), materialsList: document.getElementById('materials-list') };
        const adminDashboardEl = { studentCount: document.getElementById('admin-student-count'), notificationsCount: document.getElementById('admin-notifications-count'), opinionsCount: document.getElementById('admin-opinions-count'), ratingsCount: document.getElementById('admin-ratings-count'), studentsList: document.getElementById('admin-students-list'), opinionsList: document.getElementById('admin-opinions-list'), coursesList: document.getElementById('admin-courses-list'), aiToolsList: document.getElementById('admin-ai-tools-list'), notificationsList: document.getElementById('admin-notifications-list'), pollsCount: document.getElementById('admin-polls-count'), pollsList: document.getElementById('admin-polls-list') };
        const adminContentPanelEl = { type: document.getElementById('content-type-select'), year: document.getElementById('content-year-select'), division: document.getElementById('content-division-select'), subject: document.getElementById('content-subject-select'), title: document.getElementById('content-title-input'), body: document.getElementById('content-body-input'), saveBtn: document.getElementById('save-content-btn'), formTitle: document.getElementById('content-form-title'), contentList: document.getElementById('admin-content-list'), cancelBtn: document.getElementById('cancel-edit-btn') };
        const subjectIcons = { 'محاسبه': 'ph-calculator', 'اقتصاد': 'ph-chart-bar', 'قانون': 'ph-scales', 'اداره': 'ph-briefcase', 'تسويق': 'ph-projector-screen-chart', 'لوچيستيات': 'ph-truck', 'حاسب': 'ph-desktop-tower', 'بيانات': 'ph-database', 'برامج': 'ph-code-simple', 'رياضيات': 'ph-function', 'اتصال': 'ph-chats-circle', 'سلوك': 'ph-users-three', 'تفكير': 'ph-lightbulb', 'انتاج': 'ph-factory', 'انسان': 'ph-hand-heart', 'لغه': 'ph-translate', 'default': 'ph-book-open-text' };
        // ======================= HELPER FUNCTIONS =======================
        function containsPhoneNumber(text) {
            const phonePattern = /(?:\+?20)?\s*1[0-9]{9}|01[0-9]{8}/;
            return phonePattern.test(text.replace(/\s/g, ''));
        }
        function containsAnyDigit(text) {
            return /\d/.test(text);
        }
        function containsBadWord(text) {
            const lowerText = text.toLowerCase();
            return badWords.some(word => lowerText.includes(word));
        }
        function isContentAllowed(text) {
            return !containsBadWord(text) && !containsPhoneNumber(text) && !containsAnyDigit(text);
        }
        async function checkAndHandleContent(text, userId, userName) {
            if (isContentAllowed(text)) return true;
            try {
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) return false;
                const userData = userDoc.data();
                if (userData.isBanned) return false;
                if (userData.hasWarning) {
                    await updateDoc(userDocRef, { isBanned: true });
                    showToast(`تم حظر حسابك نهائيًا بسبب مخالفة سياسة الموقع.`, true);
                    if (currentUser && currentUser.id === userId) {
                        currentUser.isBanned = true;
                        localStorage.setItem('moraUser', JSON.stringify(currentUser));
                        setTimeout(() => {
                            showPage('auth-page');
                            renderAuthForm(false, false);
                            initVantaBackground();
                        }, 3000);
                    }
                    return false;
                } else {
                    await updateDoc(userDocRef, { hasWarning: true });
                    showToast(`تنبيه هام: سيتم حظر حسابك نهائيًا في حالة تكرار نشر محتوى غير لائق أو يحتوي على أرقام.`, true);
                    return false;
                }
            } catch (error) {
                console.error("Error in content check:", error);
                return false;
            }
        }
        async function updateUserActivity(description) {
            if (currentUser && currentUser.id && !currentUser.isAdmin) {
                try {
                    const userDocRef = doc(db, "users", currentUser.id);
                    await updateDoc(userDocRef, {
                        lastActivity: {
                            timestamp: serverTimestamp(),
                            description: description
                        }
                    });
                } catch (error) {}
            }
        }
        function getYoutubeEmbedUrl(url) {
            let videoId = '';
            try {
                if (url.includes('embed')) return url;
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                } else if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                }
            } catch(e) { console.error("Invalid URL:", e) }
            return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
        }
        window.openVideoModal = (url) => {
            const embedUrl = getYoutubeEmbedUrl(url);
            if (embedUrl) {
                const videoHTML = `<div class="video-container"><iframe src="${embedUrl}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-[70vh] rounded-lg"></iframe></div>`;
                openModalWithContent('مشاهدة الكورس', videoHTML, showCoursesList);
            } else {
                showToast("رابط الفيديو غير صالح، سيتم فتحه في نافذة جديدة.", true);
                window.open(url, '_blank');
            }
        };
        function getSubjectIcon(subjectName) { const lowerCaseName = subjectName.toLowerCase(); for (const key in subjectIcons) { if (lowerCaseName.includes(key)) return subjectIcons[key]; } return subjectIcons['default']; }
        function parseUserAgent(ua) { if (!ua) return 'N/A'; if (ua.includes('Windows')) return 'Windows PC'; if (ua.includes('Macintosh')) return 'Mac'; if (ua.includes('iPhone')) return 'iPhone'; if (ua.includes('Android')) return 'Android'; if (ua.includes('Linux')) return 'Linux'; return 'Unknown Device'; }
        function showPage(pageId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
        function showToast(message, isError = false) { const t = document.getElementById('toast-notification'), m = document.getElementById('toast-message'); m.textContent = message; t.className = `fixed top-5 right-5 glass-effect p-4 rounded-lg shadow-lg z-[2000] opacity-100 translate-y-0 transition-all duration-500 ${isError ? 'bg-red-900/50 text-white' : 'bg-green-900/50 text-white'}`; setTimeout(() => { t.className = t.className.replace('opacity-100', 'opacity-0').replace('translate-y-0', '-translate-y-12'); }, 4000); }
        const modalCloseBtn = document.querySelector('#generic-modal .modal-close-btn');
        function closeGenericModal() {
            document.getElementById('generic-modal').classList.remove('open');
        }
        function openModalWithContent(title, body, onClose = closeGenericModal) { 
            document.getElementById('modal-title').textContent = title; 
            document.getElementById('modal-body').innerHTML = body; 
            document.getElementById('generic-modal').classList.add('open'); 
            modalCloseBtn.onclick = onClose;
        }
        function initVantaBackground() { try { if (vantaEffect) return; vantaEffect = VANTA.GLOBE({ el: "#auth-page", mouseControls: true, touchControls: true, gyroControls: false, minHeight: 200.00, minWidth: 200.00, scale: 1.00, scaleMobile: 1.00, color: 0x00f5c3, color2: 0xa78bfa, backgroundColor: 0x0d0d1a, size: 1.2 }); } catch(e) { console.error("Vanta failed to initialize", e); } }
        function destroyVantaBackground() { try { if (vantaEffect) { vantaEffect.destroy(); vantaEffect = null; } } catch (e) { console.error("Vanta failed to destroy", e); } }
        function generateCheckDigit(idString) {
            const digits = idString.match(/\d/g);
            if (!digits) return 0;
            const sum = digits.map(Number).reduce((a, b) => a + b, 0);
            return sum % 10;
        }
        window.handleRedirectWithCountdown = (url, message = "جارٍ التوجيه...") => {
            openModalWithContent(message, `
                <div class="text-center p-8">
                    <i class="ph-globe-hemisphere-west text-6xl text-[var(--primary-glow)] mb-4 redirect-modal-icon"></i>
                    <p class="text-lg">جارٍ تحويلك خلال <span id="redirect-countdown" class="font-bold text-xl">3</span> ثوانٍ...</p>
                    <p class="text-xs text-slate-500 mt-4">تطوير Amr lotfy</p>
                </div>
            `);
            let count = 3;
            const countdownEl = document.getElementById('redirect-countdown');
            const interval = setInterval(() => {
                count--;
                if (countdownEl) countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(interval);
                    document.getElementById('generic-modal').classList.remove('open');
                    window.open(url, '_blank');
                }
            }, 1000);
        };
        // ======================= ONBOARDING - بدون زر تخطي =======================
        let currentOnboardingStep = 0;
        function showOnboarding() {
            if (localStorage.getItem('onboardingCompleted') === 'true') return;
            document.getElementById('onboarding-modal').style.display = 'flex';
            updateOnboardingStep(0);
        }
        function updateOnboardingStep(step) {
            currentOnboardingStep = step;
            const iconEl = document.getElementById('onboarding-icon');
            const titleEl = document.getElementById('onboarding-title');
            const textEl = document.getElementById('onboarding-text');
            const nextBtn = document.getElementById('onboarding-next-btn');
            const stepData = onboardingSteps[step];
            iconEl.innerHTML = `<i class="${stepData.icon}"></i>`;
            titleEl.textContent = stepData.title;
            textEl.textContent = stepData.text;
            if (step === onboardingSteps.length - 1) {
                nextBtn.textContent = 'إنهاء';
            } else {
                nextBtn.textContent = 'التالي';
            }
        }
        document.getElementById('onboarding-next-btn').addEventListener('click', () => {
            if (currentOnboardingStep < onboardingSteps.length - 1) {
                updateOnboardingStep(currentOnboardingStep + 1);
            } else {
                document.getElementById('onboarding-modal').style.display = 'none';
                localStorage.setItem('onboardingCompleted', 'true');
            }
        });
        // ======================= AUTHENTICATION =======================
        function renderAuthForm(isInitial = true, showRegister = false) {
            const authFormContainer = document.getElementById('auth-form-container'); 
            authFormContainer.innerHTML = `<div class="relative text-center w-full max-w-sm z-20 pb-12" style="animation: fade-in-up 0.5s 0.1s ease-out backwards;"><img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="" class="w-28 h-28 rounded-full mb-4 glowing-logo mx-auto" style="animation: fade-in-up 0.5s 0.2s ease-out backwards;" loading="lazy" decoding="async"><h1 class="text-2xl font-bold mb-1 tracking-wider text-shadow" style="color:var(--primary-glow); animation: fade-in-up 0.5s 0.3s ease-out backwards;">Welcome to Mora</h1><p class="text-xs text-slate-300 mb-6" style="animation: fade-in-up 0.5s 0.4s ease-out backwards;">For Studying</p><div id="auth-content"></div></div>`; 
            const authContent = document.getElementById('auth-content'); 
            if (isInitial) { 
                authContent.innerHTML = `<div class="space-y-3" style="animation: fade-in-up 0.6s 0.5s ease-out backwards;"><button id="go-to-register-btn" class="w-40 mx-auto block py-1.5 rounded-lg text-sm font-bold btn-celestial">إنشاء حساب</button><button id="go-to-login-btn" class="w-40 mx-auto block py-1.5 rounded-lg text-sm font-bold btn-celestial">تسجيل الدخول</button></div>`; 
                document.getElementById('go-to-register-btn').addEventListener('click', () => renderAuthForm(false, true));
                document.getElementById('go-to-login-btn').addEventListener('click', () => renderAuthForm(false, false));
            } else { 
                authContent.innerHTML = `<div class="w-full max-w-md mx-auto relative">
                                    <button id="back-to-initial-btn" class="absolute top-0 right-0 text-2xl text-slate-400 hover:text-white transition-transform hover:scale-110"><i class="ph-arrow-right"></i></button>
                                    <div class="space-y-3 pt-8">
                                        <input type="text" id="auth-name" placeholder="الاسم" class="w-full rounded-lg text-center input-field">
                                        ${showRegister ? `
                                            <select id="auth-year" class="w-full rounded-lg text-center select-field appearance-none"><option value="">اختر الفرقة</option><option value="1">الأولى</option><option value="2">الثانية</option></select>
                                            <select id="auth-division" class="w-full rounded-lg text-center select-field appearance-none"><option value="">اختر الشعبة</option><option value="international">أعمال دولية (IB)</option><option value="systems">نظم معلومات (BIS)</option></select>
                                        ` : ''}
                                        <div class="relative">
                                            <input type="password" id="auth-password" placeholder="كلمة المرور" class="w-full rounded-lg text-center input-field pr-10">
                                            <button id="toggle-password" type="button" class="absolute top-1/2 -translate-y-1/2 right-3 text-slate-400 hover:text-white"><i id="eye-icon" class="ph-eye"></i></button>
                                        </div>
                                        ${showRegister ? `
                                            <p class="text-xs text-slate-400 !-mt-2">يجب ألا تقل كلمة المرور عن 8 أحرف وأرقام بالانجليزي</p>
                                        ` : ''}
                                        <p id="auth-error-msg" class="text-red-400 h-5"></p>
                                        <button id="auth-submit-btn" class="w-full py-2 rounded-lg text-sm font-bold btn-celestial">${showRegister ? 'سجل الآن' : 'دخــــول'}</button>
                                        <button id="auth-toggle-btn" type="button" class="text-xs text-slate-400 hover:text-[var(--primary-glow)] transition">${showRegister ? 'لديك حساب بالفعل؟' : 'ليس لديك حساب؟'}</button>
                                    </div>
                                </div>`; 
                document.getElementById('back-to-initial-btn').addEventListener('click', () => renderAuthForm(true));
                document.getElementById('auth-toggle-btn').addEventListener('click', () => renderAuthForm(false, !showRegister));
                const submitBtn = document.getElementById('auth-submit-btn');
                const toggleBtn = document.getElementById('auth-toggle-btn');
                const togglePassBtn = document.getElementById('toggle-password');
                if (submitBtn) {
                    const newHandler = showRegister ? handleRegister : handleLogin;
                    submitBtn.onclick = newHandler;
                }
                if (togglePassBtn) {
                    togglePassBtn.onclick = () => {
                        const passInput = document.getElementById('auth-password');
                        const eyeIcon = document.getElementById('eye-icon');
                        const isPassword = passInput.type === 'password';
                        passInput.type = isPassword ? 'text' : 'password';
                        eyeIcon.className = isPassword ? 'ph-eye-slash' : 'ph-eye';
                    };
                }
            } 
        }
        async function handleRegister() { 
            const submitBtn = document.getElementById('auth-submit-btn'); 
            const errorMsg = document.getElementById('auth-error-msg'); 
            if (!submitBtn || !errorMsg) return;
            submitBtn.disabled = true; submitBtn.textContent = 'جاري التسجيل...'; 
            errorMsg.textContent = ''; 
            try { 
                const name = document.getElementById('auth-name').value.trim(); 
                const year = document.getElementById('auth-year').value; 
                const division = document.getElementById('auth-division').value; 
                const password = document.getElementById('auth-password').value; 
                if (!name || !year || !division || !password) throw new Error('يرجى ملء جميع الحقول'); 
                if (password.length < 8) throw new Error('كلمة المرور يجب أن تكون 8 أحرف على الأقل'); 
                const qName = query(collection(db, "users"), where("name", "==", name)); 
                const nameSnapshot = await getDocs(qName); 
                if (!nameSnapshot.empty) throw new Error('هذا الاسم مستخدم بالفعل'); 
                const yearCode = new Date().getFullYear().toString().slice(-2);
                const divisionCode = division === 'systems' ? 'BIS' : 'IB';
                const qCount = query(collection(db, "users"), where("year", "==", year), where("division", "==", division));
                const countSnapshot = await getDocs(qCount);
                const newStudentNumber = (countSnapshot.size + 1).toString().padStart(4, '0');
                const baseId = `HICMT-${yearCode}-${year}-${divisionCode}-${newStudentNumber}`;
                const checkDigit = generateCheckDigit(baseId);
                const studentId = `${baseId}-${checkDigit}`;
                let ipAddress = 'N/A', city = 'N/A', country = 'N/A'; 
                try { 
                    const ipRes = await fetch('https://api.ipify.org?format=json'); 
                    if(ipRes.ok) { 
                        const ipData = await ipRes.json(); 
                        ipAddress = ipData.ip; 
                        const geoRes = await fetch(`https://ipapi.co/${ipAddress}/json/`); 
                        if(geoRes.ok){ 
                            const geoData = await geoRes.json(); 
                            city = geoData.city || 'N/A'; country = geoData.country || 'N/A'; 
                        } 
                    } 
                } catch (e) { console.error('GeoIP Error:', e); } 
                const isBanned = await getDoc(doc(db, "banned_ips", ipAddress)); 
                if(isBanned.exists()) throw new Error("هذا الجهاز محظور من استخدام الموقع."); 
                const userAgent = navigator.userAgent; 
                const newUser = { studentId, name, year, division, password, points: 0, isBanned: false, createdAt: serverTimestamp(), lastActivity: { timestamp: serverTimestamp(), description: "انضم حديثاً" }, completedLectures: [], ipAddress, userAgent, city, country, blogContent: "", coursesUnlocked: true, cardCustomization: {}, hasRated: false, hasAgreedPrivacy: true, hasWarning: false }; 
                const docRef = await addDoc(collection(db, "users"), newUser); 
                currentUser = {id: docRef.id, ...newUser}; 
                localStorage.setItem('moraUser', JSON.stringify(currentUser)); 
                destroyVantaBackground(); 
                document.getElementById('register-sound').play();
                showPage('splash-screen');
            } catch (error) { 
                errorMsg.textContent = error.message; 
                submitBtn.disabled = false; 
                submitBtn.textContent = 'سجل الآن'; 
            } 
        }
        async function handleLogin() { 
            const submitBtn = document.getElementById('auth-submit-btn'); 
            const errorMsg = document.getElementById('auth-error-msg'); 
            if (!submitBtn || !errorMsg) return;
            submitBtn.disabled = true; 
            submitBtn.textContent = 'جاري الدخول...'; 
            errorMsg.textContent = ''; 
            try { 
                let ipAddress = 'N/A'; 
                try { 
                    const ipRes = await fetch('https://api.ipify.org?format=json'); 
                    if(ipRes.ok){ const ipData = await ipRes.json(); ipAddress = ipData.ip; } 
                } catch (e) {console.error('IP Error:', e);} 
                const isBanned = await getDoc(doc(db, "banned_ips", ipAddress)); 
                if(isBanned.exists()) throw new Error("هذا الجهاز محظور من استخدام الموقع."); 
                const name = document.getElementById('auth-name').value.trim(); 
                const password = document.getElementById('auth-password').value; 
                if (!name || !password) throw new Error('يرجى إدخال البيانات'); 
                if (name === 'admen' && password === 'Amr1221@gmail.com') { 
                    destroyVantaBackground(); 
                    currentUser = { name: 'Admin', isAdmin: true }; 
                    localStorage.setItem('moraUser', JSON.stringify(currentUser)); 
                    showPage('splash-screen'); return; 
                } 
                const q = query(collection(db, "users"), where("name", "==", name), where("password", "==", password)); 
                const snapshot = await getDocs(q); 
                if (snapshot.empty) throw new Error('البيانات غير صحيحة أو يجب عليك إنشاء حساب أولاً'); 
                const userDoc = snapshot.docs[0]; 
                if (userDoc.data().isBanned) throw new Error('هذا الحساب محظور'); 
                destroyVantaBackground(); 
                currentUser = { id: userDoc.id, ...userDoc.data() }; 
                await updateUserActivity("سجل الدخول للتو");
                localStorage.setItem('moraUser', JSON.stringify(currentUser)); 
                showPage('splash-screen');
            } catch (error) { 
                errorMsg.textContent = error.message; 
                submitBtn.disabled = false; 
                submitBtn.textContent = 'دخــــول'; 
            } 
        }
        // ======================= STUDENT DASHBOARD =======================
        function initStudentDashboard() { 
            showPage('student-dashboard'); 
            studentDashboardEl.welcomeName.textContent = `مرحبا يـ ${currentUser.name}`; 
            studentDashboardEl.userDetails.textContent = `${currentUser.year === '1' ? "الفرقة الأولى" : "الفرقة الثانية"} - ${currentUser.division === "international" ? "أعمال دولية (IB)" : "نظم معلومات (BIS)"}`; 
            studentDashboardEl.studentId.textContent = `ID: ${currentUser.studentId || 'N/A'}`;
            activateNavButtons();
            loadMaterialsForStudent(); 
            listenToSiteSettings(); 
            listenForNotifications(); 
            listenForSupportReplies();
            setTimeout(showOnboarding, 800);
            setTimeout(initAIAvatar, 1000); // ✅ تشغيل المرشد عند تحميل لوحة الطالب
        }
        function loadMaterialsForStudent() {
            const userMaterials = materials['ar'][`${currentUser.year}_${currentUser.division}`] || [];
            studentDashboardEl.materialsList.innerHTML = userMaterials.map((mat) => { 
                const iconClass = getSubjectIcon(mat); 
                return `<div class="subject-card rounded-xl p-6 flex flex-col items-center justify-center gap-4 cursor-pointer" onclick="openSubjectPage('${mat}')"> <i class="${iconClass} text-4xl" style="color: var(--primary-glow);"></i> <h4 class="text-lg font-bold text-center">${mat}</h4> </div>`;
            }).join(''); 
        }
        window.goBackToDashboard = () => { if (currentContentUnsubscribe) currentContentUnsubscribe(); showPage('student-dashboard'); document.getElementById('subject-content-page').innerHTML = ''; }
        window.openSubjectPage = async (subject) => { 
            await updateUserActivity(`يتصفح مادة: ${subject}`);
            const subjectPage = document.getElementById('subject-content-page'); 
            // ✅ زر وضع التركيز في صفحة المحاضرة
            const pageHTML = `
                <button id="focus-mode-btn" onclick="toggleFocusMode()"><i class="ph-target"></i></button>
                <header class="p-4 text-center">
                    <h2 class="text-xl font-bold text-[var(--primary-glow)]">${subject}</h2>
                    <button onclick="goBackToDashboard()" class="text-2xl hover:text-[var(--primary-glow)] transition mt-2"><i class="ph-arrow-right"></i></button>
                </header>
                <main class="flex-grow p-4 overflow-y-auto pb-5"><div id="subject-lectures" class="text-center pt-4"><i class="ph-spinner ph-spin text-2xl"></i></div></main>
            `;
            subjectPage.innerHTML = pageHTML;
            // ✅ ربط زر التركيز
            document.getElementById('focus-mode-btn').addEventListener('click', toggleFocusMode);
            showPage('subject-content-page'); 
            const lecturesContainer = document.getElementById('subject-lectures'); 
            const q = query(collection(db, 'lectures'), where("year", "==", currentUser.year), where("division", "==", currentUser.division), where("subject", "==", subject), where("isHidden", "==", false), orderBy('createdAt', 'desc')); 
            currentContentUnsubscribe = onSnapshot(q, (snapshot) => { if (snapshot.empty) { lecturesContainer.innerHTML = `<p class="text-slate-400 py-4">لا توجد محاضرات منشورة لهذه المادة حالياً.</p>`; } else { let contentHTML = '<div class="space-y-3">'; snapshot.forEach(doc => { const item = doc.data(); contentHTML += `<div class="glass-effect p-3 rounded-lg cursor-pointer hover:bg-slate-500/10 transition-colors" onclick="viewContentDetail('${doc.id}', '${item.title}', '${btoa(encodeURIComponent(item.body))}', '${subject}')"><h4 class="font-bold text-white">${item.title}</h4></div>`; }); contentHTML += '</div>'; lecturesContainer.innerHTML = contentHTML; } }, (error) => { console.error("Error:", error); lecturesContainer.innerHTML = `<p class="text-red-400 py-4">حدث خطأ أثناء تحميل المحاضرات.</p>`; }); 
        };
        // ======================= CONTENT VIEW WITH STYLING =======================
        window.viewContentDetail = async (id, title, body, subject) => { 
            await updateUserActivity(`يشاهد محاضرة: ${title}`);
            const decodedBody = decodeURIComponent(atob(body));
            // ✅ تنسيق احترافي للنص
            let formattedBody = decodedBody
                .replace(/^(#+\s*.*)$/gm, '<h2>$1</h2>')
                .replace(/^(##+\s*.*)$/gm, '<h3>$1</h3>')
                .replace(/^\*\s+(.*)$/gm, '<li>$1</li>')
                .replace(/(?<!<li>)(<li>.*<\/li>)/g, '<ul>$1</ul>')
                .replace(/(?<!<\/ul>)<\/ul>(?!\s*<\/ul>)/g, '</ul>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>');
            // Ensure proper list wrapping
            formattedBody = formattedBody.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
            formattedBody = formattedBody.replace(/<\/ul>\s*<ul>/g, '');
            openModalWithContent(title, `<div class="lecture-content p-2">${formattedBody}</div>`); 
        };
        // ======================= BOOKS WITH DOWNLOAD ONLY =======================
        window.showSubjectSelectionModal = (type) => { 
            updateUserActivity(`يتصفح قسم ${type === 'books' ? 'الكتب' : 'السكاشن'}`);
            const userMaterials = materials['ar'][`${currentUser.year}_${currentUser.division}`] || []; 
            const title = type === 'books' ? 'الكتب' : 'السكاشن'; 
            if (userMaterials.length === 0) { 
                openModalWithContent(title, '<p class="text-center text-slate-400">لا توجد مواد متاحة.</p>'); 
                return; 
            } 
            const subjectsHTML = userMaterials.map(mat => `<div class="glass-effect p-3 rounded-lg cursor-pointer hover:bg-[var(--glass-border)] transition" onclick="openContentModal('${type}', '${mat}')"><h4 class="text-lg font-semibold">${mat}</h4></div>`).join(''); 
            openModalWithContent(`اختر المادة - ${title}`, `<div class="space-y-3">${subjectsHTML}</div>`); 
        };
        window.openContentModal = async (type, subject) => { 
            const title = `${type === 'books' ? 'الكتب' : 'السكاشن'} - ${subject}`; 
            openModalWithContent(title, `<div id="modal-content-list" class="text-center"><i class="ph-spinner ph-spin text-2xl"></i></div>`); 
            const container = document.getElementById('modal-content-list'); 
            const q = query(collection(db, type), where("year", "==", currentUser.year), where("division", "==", currentUser.division), where("subject", "==", subject), where("isHidden", "==", false), orderBy('createdAt', 'desc')); 
            currentContentUnsubscribe = onSnapshot(q, (snapshot) => { 
                let content = ''; 
                if (snapshot.empty) { 
                    content = `<div class="text-center p-4"><p>لا يوجد محتوى في هذا القسم حالياً.</p></div>`; 
                } else { 
                    content = '<div class="space-y-3">'; 
                    snapshot.forEach(doc => { 
                        const item = doc.data(); 
                        const isUrl = item.body.startsWith('http'); 
                        if (type === 'books' && isUrl) {
                            // ✅ فقط زر "تحميل" بدون "مشاهدة"
                            content += `
                                <div class="glass-effect p-4 rounded-xl">
                                    <h5 class="font-bold text-white text-lg">${item.title}</h5>
                                    <div class="book-actions">
                                        <button class="book-btn download-btn" onclick="window.open('${item.body}', '_blank')">تحميل</button>
                                    </div>
                                </div>
                            `;
                        } else {
                            content += `<div class="glass-effect p-3 rounded-lg"><h4 class="font-bold text-[var(--primary-glow)]">${item.title}</h4>${isUrl ? `<button class="w-full mt-2 py-2 rounded-lg text-sm btn-celestial" onclick="openIframeModal('${item.body}')">فتح الملف</button>` : `<p class="text-sm mt-2">${item.body}</p>`}</div>`;
                        }
                    }); 
                    content += '</div>'; 
                } 
                container.innerHTML = content; 
            }); 
        };
        window.openIframeModal = (url) => { 
            openModalWithContent("عرض الملف", `<iframe src="${url}" class="w-full h-[70vh] rounded-lg bg-white" frameborder="0"></iframe>`); 
        };
        async function listenToSiteSettings() { 
            onSnapshot(doc(db, "settings", "site"), async (doc) => { 
                siteSettings = doc.data() || { meetingActive: false, coursesActive: true, isLive: false, meetLink: ''};
                const meetingBtn = document.getElementById('meeting-btn');
                const indicator = document.getElementById('meeting-live-indicator');
                const banner = document.getElementById('live-attendance-banner');
                const materials = materials['ar'][`${currentUser?.year}_${currentUser?.division}`] || [];
                const isLogisticsSubject = materials.includes('اداره اللوچيستيات وسلاسل الامداد');
                if (siteSettings.isLive && isLogisticsSubject) {
                    indicator.classList.remove('hidden');
                    banner.style.display = 'block';
                    banner.textContent = '🎓 اضغط هنا للدخول وحضور المحاضرة مباشرة!';
                } else if (!siteSettings.isLive && isLogisticsSubject) {
                    indicator.classList.add('hidden');
                    banner.style.display = 'block';
                    banner.textContent = 'انتهى البث.';
                    banner.style.backgroundColor = '#374151';
                    banner.onclick = null;
                } else {
                    indicator.classList.add('hidden');
                    banner.style.display = 'none';
                }
            }); 
        }
        async function showCoursesList() {
            await updateUserActivity("يتصفح قسم الكورسات");
            const q = query(collection(db, "courses"), orderBy("category"));
            const snapshot = await getDocs(q);
            let content = '<div class="space-y-4">';
            if (snapshot.empty) {
                content += '<p class="text-center text-slate-400">لا توجد كورسات متاحة حالياً.</p>';
            } else {
                 const coursesByCategory = {};
                 snapshot.forEach(doc => {
                     const course = doc.data();
                     const category = course.category || 'متنوع';
                     if (!coursesByCategory[category]) {
                         coursesByCategory[category] = [];
                     }
                     coursesByCategory[category].push({ id: doc.id, ...course });
                 });
                 for (const category in coursesByCategory) {
                     content += `<h4 class="text-lg font-bold text-[var(--primary-glow)] pt-2 border-b-2 border-[var(--glass-border)] pb-2">${category}</h4>`;
                     coursesByCategory[category].forEach(course => {
                         content += `
                            <div class="glass-effect p-4 rounded-xl">
                                <h5 class="font-bold text-white text-lg">${course.title}</h5>
                                <p class="text-sm text-slate-400 mt-1">${course.desc}</p>
                                <div class="course-actions">
                                    <button class="course-btn watch-btn" onclick="window.openVideoModal('${course.url}')">مشاهدة</button>
                                    <button class="course-btn download-btn" onclick="window.open('${course.url}', '_blank')">تحميل</button>
                                </div>
                            </div>
                         `;
                     });
                 }
            }
            content += '</div>';
            openModalWithContent('الكورسات المجانية', content);
        }
        document.getElementById('courses-btn').addEventListener('click', async () => {
            showCoursesList();
        });
        // ======================= MEETING BUTTON HANDLER =======================
        document.getElementById('meeting-btn').addEventListener('click', async () => {
            if (!currentUser || currentUser.isAdmin) return;
            if (!siteSettings.isLive) {
                showToast(siteTexts.meetingLockedToast || defaultTexts.meetingLockedToast, true);
                return;
            }
            try {
                const attendanceRef = collection(db, "attendance");
                await addDoc(attendanceRef, {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userYear: currentUser.year,
                    userDivision: currentUser.division,
                    timestamp: serverTimestamp(),
                    meetLink: siteSettings.meetLink || ''
                });
                showToast("تم تسجيل حضورك بنجاح!");
                if (siteSettings.meetLink) {
                    openModalWithContent("جاري تحويلك الآن...", `
                        <div class="text-center p-8">
                            <i class="ph-video text-6xl text-[var(--primary-glow)] mb-4 redirect-modal-icon"></i>
                            <p class="text-lg">سيتم تحويلك خلال <span id="redirect-countdown" class="font-bold text-xl">3</span> ثوانٍ...</p>
                        </div>
                    `);
                    let count = 3;
                    const countdownEl = document.getElementById('redirect-countdown');
                    const interval = setInterval(() => {
                        count--;
                        if (countdownEl) countdownEl.textContent = count;
                        if (count <= 0) {
                            clearInterval(interval);
                            document.getElementById('generic-modal').classList.remove('open');
                            window.open(siteSettings.meetLink, '_blank');
                        }
                    }, 1000);
                } else {
                    showToast("رابط البث غير متوفر حاليًا.", true);
                }
            } catch (error) {
                console.error("Error recording attendance:", error);
                showToast("حدث خطأ أثناء تسجيل الحضور.", true);
            }
        });
        // ======================= LIVE ATTENDANCE BANNER CLICK =======================
        window.handleLiveAttendanceBannerClick = async () => {
            if (!currentUser || currentUser.isAdmin) return;
            if (!siteSettings.isLive) return;
            try {
                const attendanceRef = collection(db, "attendance");
                await addDoc(attendanceRef, {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userYear: currentUser.year,
                    userDivision: currentUser.division,
                    timestamp: serverTimestamp(),
                    meetLink: siteSettings.meetLink || ''
                });
                showToast("تم تسجيل حضورك بنجاح!");
                if (siteSettings.meetLink) {
                    openModalWithContent("جاري تحويلك الآن...", `
                        <div class="text-center p-8">
                            <i class="ph-video text-6xl text-[var(--primary-glow)] mb-4 redirect-modal-icon"></i>
                            <p class="text-lg">سيتم تحويلك خلال <span id="redirect-countdown" class="font-bold text-xl">3</span> ثوانٍ...</p>
                        </div>
                    `);
                    let count = 3;
                    const countdownEl = document.getElementById('redirect-countdown');
                    const interval = setInterval(() => {
                        count--;
                        if (countdownEl) countdownEl.textContent = count;
                        if (count <= 0) {
                            clearInterval(interval);
                            document.getElementById('generic-modal').classList.remove('open');
                            window.open(siteSettings.meetLink, '_blank');
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error("Error in banner attendance:", error);
                showToast("حدث خطأ أثناء تسجيل الحضور.", true);
            }
        };
        // ======================= SUMMARY SECTION =======================
        document.getElementById('summary-nav-btn').addEventListener('click', () => {
            updateUserActivity("يفتح قسم التلخيص");
            const summaryHTML = `
                <div class="p-4 space-y-4 text-center">
                    <h3 class="text-xl font-bold text-[var(--primary-glow)]">تلخيص المحاضرات</h3>
                    <p class="text-slate-300">استخدم الذكاء الاصطناعي لتلخيص المحاضرات، طرح الأسئلة، وفهم أعمق.</p>
                    <div class="mt-6">
                        <button class="btn-celestial py-2 px-6 rounded-lg font-bold" onclick="handleRedirectWithCountdown('https://notebooklm.google.com/notebook/4537acf2-d026-4183-9a99-e7bb06f3c059')">
                            الذهاب إلى NotebookLM
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-6">تطوير Amr lotfy</p>
                </div>
            `;
            openModalWithContent('تلخيص', summaryHTML);
        });
        // ======================= POLLS/DISCUSSION FEATURE - بدون حد للكلمات =======================
        async function openPollsView() {
            updateUserActivity("يتصفح الاستطلاعات");
            const pollsHTML = `
                <div class="space-y-4">
                    <div class="content-policy-notice">
                        <strong>تنبيه هام:</strong> يُمنع تمامًا نشر أي محتوى يحتوي على ألفاظ غير لائقة، شتائم، أرقام، أو محتوى مخل. سيتم إصدار تحذير عند المخالفة الأولى، وحظر الحساب نهائيًا عند التكرار.
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-300 mb-2">ابدأ موضوعًا جديدًا</h4>
                        <textarea id="poll-topic-input" class="w-full rounded-lg input-field" rows="4" placeholder="اكتب سؤالك أو رأيك هنا..."></textarea>
                        <button id="submit-poll-btn" class="w-full mt-2 py-2 rounded-lg font-bold btn-celestial">نشر الموضوع</button>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-300 mb-2 border-t border-slate-700/50 pt-4">المواضيع الحالية</h4>
                        <div id="polls-list-container" class="space-y-3 max-h-72 overflow-y-auto">
                            <p class="text-slate-400 text-center">جاري تحميل المواضيع...</p>
                        </div>
                    </div>
                </div>
            `;
            openModalWithContent('الاستطلاعات والمناقشات', pollsHTML);
            document.getElementById('submit-poll-btn').addEventListener('click', submitNewPoll);
            const q = query(collection(db, "polls"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('polls-list-container');
                if (!container) return;
                let listHTML = '';
                if (snapshot.empty) {
                    listHTML = '<p class="text-slate-400 text-center">لا توجد مواضيع للنقاش حاليًا. كن أول من يبدأ!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const poll = doc.data();
                        const divisionText = poll.userDivision === 'international' ? 'أعمال دولية' : 'نظم معلومات';
                        const yearText = poll.userYear === '1' ? 'الفرقة الأولى' : 'الثانية';
                        const dateText = poll.createdAt ? poll.createdAt.toDate().toLocaleString('ar-EG-u-nu-latn', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : '';
                        listHTML += `
                            <div class="poll-item">
                                <div class="poll-header">
                                    <span class="poll-author">${poll.userName}</span>
                                    <span class="poll-time">${dateText}</span>
                                </div>
                                <div class="poll-body">${poll.topic}</div>
                                <div class="poll-replies" id="replies-${doc.id}">
                                    <p class="text-slate-500 text-sm">جارٍ تحميل الردود...</p>
                                </div>
                                <div class="mt-3">
                                    <textarea id="reply-${doc.id}" class="w-full rounded-lg input-field text-sm" rows="2" placeholder="اكتب ردك..."></textarea>
                                    <button onclick="submitNewReply('${doc.id}')" class="w-full mt-2 py-1.5 rounded-lg text-sm font-bold btn-celestial">رد</button>
                                </div>
                            </div>
                        `;
                    });
                }
                container.innerHTML = listHTML;
                // Load replies for each poll
                snapshot.forEach(doc => {
                    const pollDocRef = doc(db, "polls", doc.id);
                    const repliesQuery = query(collection(pollDocRef, "replies"), orderBy("createdAt", "asc"));
                    onSnapshot(repliesQuery, (repliesSnap) => {
                        const repliesContainer = document.getElementById(`replies-${doc.id}`);
                        if (!repliesContainer) return;
                        let repliesHTML = '';
                        if (repliesSnap.empty) {
                            repliesHTML = '<p class="text-slate-500 text-sm">لا توجد ردود بعد.</p>';
                        } else {
                            repliesSnap.forEach(replyDoc => {
                                const reply = replyDoc.data();
                                repliesHTML += `
                                    <div class="reply-item">
                                        ${reply.replyText}
                                        <div class="reply-author">${reply.userName}</div>
                                    </div>
                                `;
                            });
                        }
                        repliesContainer.innerHTML = repliesHTML;
                    });
                });
            });
        }
        async function submitNewPoll() {
            const input = document.getElementById('poll-topic-input');
            const topic = input.value.trim();
            if (!topic) {
                showToast('لا يمكن نشر موضوع فارغ.', true);
                return;
            }
            const isAllowed = await checkAndHandleContent(topic, currentUser.id, currentUser.name);
            if (!isAllowed) return;
            await addDoc(collection(db, "polls"), {
                userId: currentUser.id,
                userName: currentUser.name,
                userYear: currentUser.year,
                userDivision: currentUser.division,
                topic: topic,
                createdAt: serverTimestamp(),
                isReadByAdmin: false
            });
            showToast('تم نشر موضوعك بنجاح!');
            input.value = '';
        }
        async function submitNewReply(pollId) {
            const input = document.getElementById(`reply-${pollId}`);
            const replyText = input.value.trim();
            if (!replyText) {
                showToast('لا يمكن إضافة رد فارغ.', true);
                return;
            }
            const isAllowed = await checkAndHandleContent(replyText, currentUser.id, currentUser.name);
            if (!isAllowed) return;
            const repliesRef = collection(doc(db, "polls", pollId), "replies");
            await addDoc(repliesRef, {
                userId: currentUser.id,
                userName: currentUser.name,
                replyText: replyText,
                createdAt: serverTimestamp()
            });
            input.value = '';
        }
        // =========================================================================
        function activateNavButtons() {
            document.getElementById('platform-btn').addEventListener('click', () => {
                handleRedirectWithCountdown('https://tanta-services.online/TantaPortal/studentindex.php?t=first', 'المنصة الرسمية');
            });
            document.querySelectorAll('.bottom-nav-btn[data-modal]').forEach(btn => btn.addEventListener('click', async e => {
                const type = e.currentTarget.dataset.modal; 
                if (currentContentUnsubscribe) currentContentUnsubscribe(); 
                if (type === 'opinions-modal') { 
                    updateUserActivity('يتصفح قسم الآراء'); 
                    const opinionsHTML = `
                        <div class="content-policy-notice">
                            <strong>تنبيه هام:</strong> يُمنع تمامًا نشر أي محتوى يحتوي على ألفاظ غير لائقة، شتائم، أرقام، أو محتوى مخل. سيتم إصدار تحذير عند المخالفة الأولى، وحظر الحساب نهائيًا عند التكرار.
                        </div>
                        <div id="opinions-view" class="space-y-3 mb-4 max-h-60 overflow-y-auto"></div>
                        <textarea id="opinion-input" class="w-full rounded-lg input-field mt-4" rows="3" placeholder="اكتب رأيك هنا..."></textarea>
                        <button id="submit-opinion-btn" class="w-full mt-2 py-2 rounded-lg font-bold btn-celestial">نشر الرأي</button>
                    `;
                    openModalWithContent('آراء الطلاب', opinionsHTML); 
                    onSnapshot(query(collection(db, "opinions"), orderBy('createdAt', 'desc')), snap => { 
                        document.getElementById('opinions-view').innerHTML = snap.docs.map(d => { 
                            const o = d.data(); 
                            return `<div class="p-3 rounded-lg hover:bg-slate-500/10"><p>"${o.text}"</p><p class="text-xs text-slate-400 mt-2 font-bold">${o.name} - فرقة ${o.year}</p></div>`; 
                        }).join('') || '<p class="text-center text-slate-400">لا توجد آراء بعد.</p>'; 
                    }); 
                } 
                if (type === 'polls-modal') { openPollsView(); }
                if (type === 'about-modal') { 
                    const aboutHTML = `<div class="text-center p-2 flex flex-col items-center space-y-4 w-full">
                        <p class="text-lg text-slate-300" data-text-key="aboutMain"></p>
                        <div class="my-2">
                            <p class="font-bold text-lg text-shadow-lg" style="color:var(--primary-glow)" data-text-key="aboutDeveloper"></p>
                        </div>
                        <hr class="w-full border-t border-[var(--glass-border)]">
                        <p class="font-bold text-slate-400" data-text-key="aboutSupervisors"></p>
                        <div class="space-y-2">
                            <p class="font-bold" style="color:var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow);">ا. د/ عبدالمنعم الدسوقي</p>
                            <p class="font-bold" style="color:var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow);">ا. د/ابراهيم ماريه</p>
                            <p class="font-bold" style="color:var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow);">د/مصطفى عبدالمنعم</p>
                        </div>
                        <hr class="w-full border-t border-[var(--glass-border)]">
                        <div class="flex justify-center items-center gap-6 my-4">
                            <a href="#" onclick="event.preventDefault(); handleRedirectWithCountdown('https://wa.me/201067941806')" class="social-icon-animated text-3xl" style="color: #25D366; --glow-color: #25D366;"><i class="ph-whatsapp-logo"></i></a>
                            <a href="#" onclick="event.preventDefault(); handleRedirectWithCountdown('https://www.facebook.com/share/1CDtFCSPVD/')" class="social-icon-animated text-3xl" style="color: #1877F2; --glow-color: #1877F2; animation-delay: -2s;"><i class="ph-facebook-logo"></i></a>
                            <a href="#" onclick="event.preventDefault(); handleRedirectWithCountdown('mailto:amrloutfy2006@gmail.com')" class="social-icon-animated text-3xl" style="color: #EA4335; --glow-color: #EA4335; animation-delay: -4s;"><i class="ph-envelope"></i></a>
                        </div>
                        <p class="text-xs text-slate-500">تطوير Amr lotfy</p>
                    </div>`;
                    openModalWithContent('عنا', aboutHTML); 
                    applySiteTexts(); 
                } 
                if (type === 'settings-modal') { 
                    updateUserActivity("يفتح الإعدادات");
                    let themesHTML = '';
                    for (const key in themes) { themesHTML += `<button data-theme="${key}" class="theme-btn py-2 rounded-lg flex items-center justify-center gap-2"> <div class="w-4 h-4 rounded-full border border-slate-500/50" style="background:${themes[key].p}"></div> ${themes[key].n}</button>`; }
                    const settingsHTML = `<div class="space-y-6 p-2"><h4 class="text-lg font-bold text-slate-300">الثيم اللوني</h4><div id="theme-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">${themesHTML}</div></div>`; 
                    openModalWithContent('الإعدادات', settingsHTML); 
                    const currentTheme = localStorage.getItem('moraTheme') || 'default';
                    document.querySelector(`.theme-btn[data-theme="${currentTheme}"]`).classList.add('bg-[var(--primary-glow)]', 'text-black', 'font-bold');
                } 
                if (type === 'ai-tools-modal') { 
                    updateUserActivity("يتصفح أدوات الذكاء الاصطناعي"); 
                    const q = query(collection(db, "ai_tools")); 
                    const snapshot = await getDocs(q); 
                    let content = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">'; 
                    if(snapshot.empty){ 
                        content += '<p class="md:col-span-2 text-center">لا توجد أدوات حالياً.</p>'; 
                    } else { 
                        snapshot.forEach(doc => { 
                            const t = doc.data(); 
                            content += `<div onclick="handleRedirectWithCountdown('${t.url}')" class="p-3 rounded-lg cursor-pointer transition-all duration-300 hover:bg-slate-500/20"><h5 class="font-bold text-white">${t.name}</h5><p class="text-xs text-slate-400">${t.desc}</p></div>`; 
                        }); 
                    } 
                    content += '</div>'; 
                    openModalWithContent('أدوات الذكاء الاصطناعي', content); 
                } 
                if (type === 'support-modal') {
                    updateUserActivity('يفتح قسم الدعم الفني');
                    markStudentTicketsAsRead();
                    const supportHTML = `
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-bold text-slate-300 mb-2">تقديم شكوى أو استفسار</h4>
                                <textarea id="support-problem-input" class="w-full rounded-lg input-field" rows="4" placeholder="اكتب تفاصيل مشكلتك هنا..."></textarea>
                                <button id="submit-support-ticket-btn" class="w-full mt-2 py-2 rounded-lg font-bold btn-celestial">إرسال</button>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-slate-300 mb-2">تذاكر الدعم الخاصة بك</h4>
                                <div id="support-tickets-list" class="space-y-3 max-h-60 overflow-y-auto">
                                    <p class="text-slate-400 text-center">جاري تحميل تذاكرك...</p>
                                </div>
                            </div>
                        </div>`;
                    openModalWithContent('الدعم الفني', supportHTML);
                    const q = query(collection(db, "support_tickets"), where("userId", "==", currentUser.id), orderBy("createdAt", "desc"));
                    onSnapshot(q, (snapshot) => {
                        const container = document.getElementById('support-tickets-list');
                        if (!container) return;
                        if (snapshot.empty) {
                            container.innerHTML = '<p class="text-slate-400 text-center">لا توجد لديك تذاكر دعم سابقة.</p>';
                            return;
                        }
                        let ticketsHTML = '';
                        snapshot.forEach(doc => {
                            const ticket = doc.data();
                            const statusColor = ticket.status === 'تم الرد' ? 'text-green-400' : 'text-yellow-400';
                            const adminReply = ticket.adminReply ? `<div class="mt-2 pt-2 border-t border-slate-600"><p class="text-sm font-bold text-green-400">رد الإدارة:</p><p class="text-sm text-slate-200">${ticket.adminReply}</p></div>` : '';
                            ticketsHTML += `
                                <div class="glass-effect p-3 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <p class="text-xs text-slate-400">${ticket.createdAt.toDate().toLocaleString('ar-EG')}</p>
                                        <span class="text-sm font-bold ${statusColor}">${ticket.status}</span>
                                    </div>
                                    <p class="mt-2 text-white">${ticket.problem}</p>
                                    ${adminReply}
                                </div>`;
                        });
                        container.innerHTML = ticketsHTML;
                    });
                }
            }));
            document.getElementById('digital-card-nav-btn').addEventListener('click', () => {
                updateUserActivity("يفتح بطاقته الرقمية");
                const issueDate = currentUser.createdAt && currentUser.createdAt.seconds ? new Date(currentUser.createdAt.seconds * 1000).toLocaleDateString('ar-EG') : new Date().toLocaleDateString('ar-EG');
                const cardHTML = `
                    <div class="p-4 rounded-2xl bg-gradient-to-br from-slate-800 via-slate-900 to-black w-full max-w-md mx-auto shadow-2xl shadow-black/50 border border-[var(--primary-glow)] relative overflow-hidden" 
                        style="background-image: radial-gradient(circle at 30% 30%, rgba(0, 245, 195, 0.15) 0%, transparent 40%), radial-gradient(circle at 70% 70%, rgba(167, 139, 250, 0.1) 0%, transparent 40%);">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div class="text-right">
                                    <h4 class="text-lg font-bold text-white text-right">بطاقة طالب رقمية</h4>
                                    <p class="text-xs text-slate-400 text-right">المعهد العالي للحاسبات وتكنولوجيا الإدارة</p>
                                </div>
                                <div class="relative">
                                    <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="Logo" class="w-16 h-16 rounded-full border-2 border-[var(--primary-glow)] shadow-lg shadow-[var(--primary-glow)]/30">
                                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
                                </div>
                            </div>
                            <div class="mt-6 text-right">
                                <p class="text-sm text-slate-400">الاســـــم</p>
                                <p class="text-2xl font-bold text-white -mt-1">${currentUser.name}</p>
                                <p class="text-sm text-slate-400 mt-2">التخصص</p>
                                <p class="text-lg font-semibold text-slate-200 -mt-1">${currentUser.year === '1' ? "الفرقة الأولى" : "الفرقة الثانية"} - ${currentUser.division === "international" ? "أعمال دولية (IB)" : "نظم معلومات (BIS)"}</p>
                            </div>
                            <div class="flex justify-between items-end mt-4">
                                <div class="text-right">
                                    <p class="text-xs text-slate-500">تاريخ الإصدار</p>
                                    <p class="text-sm font-mono text-slate-300">${issueDate}</p>
                                </div>
                                <div id="qrcode-container" class="p-1.5 bg-white rounded-md inline-block shadow-lg"></div>
                            </div>
                            <div class="mt-4 bg-gradient-to-r from-[var(--primary-glow)]/20 to-[var(--secondary-glow)]/20 p-2 rounded-lg text-center backdrop-blur-sm">
                                <p class="font-mono text-lg md:text-xl text-[var(--primary-glow)] tracking-wider whitespace-nowrap">${currentUser.studentId || 'ID غير متوفر'}</p>
                                <p class="text-xs text-slate-300 mt-1">استخدم هذا الرقم التعريفي (ID) في أي مكان يتطلب التحقق من هويتك كطالب.</p>
                            </div>
                        </div>
                    </div>
                `;
                openModalWithContent('بطاقتك الرقمية', cardHTML);
                const qrContainer = document.getElementById('qrcode-container');
                if(qrContainer && currentUser.studentId) {
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, { text: currentUser.studentId, width: 90, height: 90, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
                } else if (qrContainer) {
                    qrContainer.innerHTML = '<p class="text-center text-xs p-2 text-red-500">ID غير<br>متوفر</p>';
                }
            });
            document.getElementById('privacy-policy-nav-btn').addEventListener('click', () => {
                updateUserActivity("يقرأ سياسة الخصوصية");
                openModalWithContent('سياسة الخصوصية', '<div class="p-2 text-sm text-slate-300 space-y-3"><p><strong>مقدمة:</strong> نحن في منصة "Mora For Studying" نأخذ خصوصية بياناتك على محمل الجد.</p><p><strong>البيانات التي نجمعها:</strong> عند إنشاء حساب، نقوم بجمع الاسم، الفرقة، الشعبة، بالإضافة إلى IP Address ونوع الجهاز لأغراض أمنية وتحليلية.</p><p><strong>استخدام البيانات:</strong> لا يتم مشاركة بياناتك الشخصية مع أي طرف ثالث. تستخدم البيانات داخلياً لتحسين تجربتك وتأمين المنصة.</p><p class="font-bold text-red-400 border-t border-red-500/30 pt-3 mt-3"><strong>سياسة الاستخدام العادل:</strong> أي محاولة لإساءة استخدام الموقع، أو نشر محتوى غير لائق، أو التحايل على نظام النقاط سيؤدي إلى <strong>الحظر الفوري والدائم للحساب</strong> دون سابق إنذار.</p><p class="text-xs text-slate-500 text-center pt-3">تطوير Amr lotfy</p></div>');
            });
            document.getElementById('study-timer-nav-btn').addEventListener('click', () => {
                updateUserActivity("يفتح تايمر المذاكرة");
                openModalWithContent('تايمر المذاكرة', `<div class="text-center p-4 flex flex-col items-center"><p id="timer-display" class="text-6xl font-mono tracking-widest mb-6">${formatTime(timerState.duration)}</p><div class="flex gap-4"><button id="timer-start-btn" class="w-24 py-2 rounded-lg text-base font-bold btn-celestial">بدء</button><button id="timer-reset-btn" class="w-24 py-2 rounded-lg text-base font-bold btn-celestial border-amber-500 text-amber-500 hover:bg-amber-500 hover:text-black">إعادة ضبط</button></div></div>`); 
                document.getElementById('timer-start-btn').onclick = () => timerState.running ? stopTimer() : startTimer(); 
                document.getElementById('timer-reset-btn').onclick = () => { stopTimer(); timerState.duration = 25 * 60; updateTimerDisplay(); };
            });
            document.getElementById('account-options-btn').addEventListener('click', () => {
                 updateUserActivity("يفتح خيارات الحساب");
                 openModalWithContent('خيارات الحساب', `<div class="space-y-3 p-2"><button id="logout-btn" class="w-full text-center p-3 rounded-lg hover:bg-red-500/20 transition text-red-400 font-semibold">تسجيل الخروج</button><button id="clear-data-btn" class="w-full text-center p-3 rounded-lg hover:bg-slate-500/20 transition">محو بياناتي من الجهاز</button></div>`);
            });
        }
        document.body.addEventListener('click', async e => { 
            if (e.target.id === 'submit-opinion-btn') { 
                const input = document.getElementById('opinion-input'); 
                const text = input.value.trim(); 
                if (!text) { showToast('لا يمكن نشر رأي فارغ', true); return; }
                const isAllowed = await checkAndHandleContent(text, currentUser.id, currentUser.name);
                if (!isAllowed) return;
                await updateUserActivity("كتب رأياً جديداً");
                await addDoc(collection(db, "opinions"), { name: currentUser.name, year: currentUser.year, text, createdAt: serverTimestamp() }); 
                showToast('تم نشر رأيك بنجاح!'); 
                document.getElementById('generic-modal').classList.remove('open'); 
            } 
            if (e.target.id === 'submit-support-ticket-btn') {
                const input = document.getElementById('support-problem-input');
                const problem = input.value.trim();
                if (!problem) { showToast('يرجى كتابة وصف للمشكلة.', true); return; }
                await updateUserActivity("أرسل تذكرة دعم");
                await addDoc(collection(db, "support_tickets"), {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    problem: problem,
                    status: 'جديدة',
                    createdAt: serverTimestamp(),
                    adminReply: '',
                    isReadByAdmin: false,
                    isReadByStudent: true
                });
                showToast('تم إرسال مشكلتك بنجاح، سيتم الرد عليك قريباً.');
                input.value = '';
            }
            if (e.target.closest('.theme-btn')) { const themeKey = e.target.closest('.theme-btn').dataset.theme; applyTheme(themeKey); document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('bg-[var(--primary-glow)]', 'text-black', 'font-bold')); e.target.closest('.theme-btn').classList.add('bg-[var(--primary-glow)]', 'text-black', 'font-bold'); }
            if (e.target.id === 'logout-btn') { handleLogout(); } 
            if (e.target.id === 'clear-data-btn') { if (confirm('هل أنت متأكد من محو جميع بياناتك؟ سيتم تسجيل خروجك.')) { localStorage.clear(); currentUser = null; document.getElementById('generic-modal').classList.remove('open'); showPage('auth-page'); renderAuthForm(false, true); initVantaBackground(); }} 
        });
        let lastNotificationTimestamp = null;
        function listenForNotifications() { const q = query(collection(db, 'notifications'), orderBy('createdAt', 'desc'), limit(1)); onSnapshot(q, (snapshot) => { if (!snapshot.empty) { const latestNotif = snapshot.docs[0].data(); if (!lastNotificationTimestamp || latestNotif.createdAt.toMillis() > lastNotificationTimestamp) { lastNotificationTimestamp = latestNotif.createdAt.toMillis(); showToast(`إشعار جديد: ${latestNotif.body}`); document.getElementById('notification-dot').classList.remove('hidden'); document.getElementById('notifications-bell').querySelector('i').style.animation = 'notification-bell 2s ease-in-out'; setTimeout(() => { document.getElementById('notifications-bell').querySelector('i').style.animation = ''; }, 2000); } } }); }
        document.getElementById('notifications-bell').addEventListener('click', () => { document.getElementById('notification-dot').classList.add('hidden'); openModalWithContent('الإشعارات', '<div id="notifications-list" class="space-y-3"></div>'); const q = query(collection(db, 'notifications'), orderBy('createdAt', 'desc')); onSnapshot(q, (snapshot) => { const listEl = document.getElementById('notifications-list'); if (listEl) { listEl.innerHTML = snapshot.docs.map(doc => { const n = doc.data(); return `<div class="p-3 rounded-lg bg-slate-800/50"><p class="font-bold text-white">${n.title || ''}</p><p>${n.body}</p><p class="text-xs text-slate-500 mt-1">${n.createdAt.toDate().toLocaleString('ar-EG')}</p></div>`; }).join('') || '<p class="text-center text-slate-400">لا توجد إشعارات.</p>'; } }); });
        async function markStudentTicketsAsRead() {
            const q = query(collection(db, "support_tickets"), where("userId", "==", currentUser.id), where("isReadByStudent", "==", false));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return;
            const batch = writeBatch(db);
            snapshot.forEach(doc => {
                batch.update(doc.ref, { isReadByStudent: true });
            });
            await batch.commit();
        }
        function listenForSupportReplies() {
            const supportNavBtn = document.querySelector('[data-modal="support-modal"]');
            if (!supportNavBtn) return;
            const q = query(collection(db, "support_tickets"), where("userId", "==", currentUser.id), where("isReadByStudent", "==", false));
            onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                let badge = supportNavBtn.querySelector('.notification-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    supportNavBtn.appendChild(badge);
                }
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            });
        }
        async function markAdminItemsAsRead(collectionName) {
            const q = query(collection(db, collectionName), where("isReadByAdmin", "==", false));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return;
            const batch = writeBatch(db);
            snapshot.forEach(doc => {
                batch.update(doc.ref, { isReadByAdmin: true });
            });
            await batch.commit();
        }
        function listenForNewAdminNotifications() {
            const collectionsToWatch = {
                'tickets-panel': 'support_tickets',
                'opinions-panel': 'opinions',
                'polls-panel': 'polls',
                'attendance-panel': 'attendance',
            };
            for (const [panelId, collectionName] of Object.entries(collectionsToWatch)) {
                const navBtn = document.querySelector(`[data-panel="${panelId}"]`);
                if (navBtn) {
                    navBtn.addEventListener('click', () => markAdminItemsAsRead(collectionName));
                    const q = query(collection(db, collectionName), where("isReadByAdmin", "==", false));
                    onSnapshot(q, (snapshot) => {
                        const count = snapshot.size;
                        let badge = navBtn.querySelector('.notification-badge');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'notification-badge';
                            badge.style.right = 'auto'; 
                            badge.style.left = '8px';
                            navBtn.appendChild(badge);
                        }
                        if (count > 0) {
                            badge.textContent = count;
                            badge.style.display = 'flex';
                            document.getElementById('admin-notification-sound').play();
                        } else {
                            badge.style.display = 'none';
                        }
                    });
                }
            }
        }
        function showCountdownModal(title, callback) { openModalWithContent(title, `<div class="text-center p-8"><p class="text-lg">سيتم الإجراء خلال <span id="countdown-span" class="font-bold text-xl text-[var(--primary-glow)]">3</span>...</p></div>`); let count = 3; const countdownSpan = document.getElementById('countdown-span'); const interval = setInterval(() => { count--; if(countdownSpan) countdownSpan.textContent = count > 0 ? count + '...' : 'الآن!'; if (count <= 0) { clearInterval(interval); callback(); } }, 1000); }
        function handleLogout() { showCountdownModal('تسجيل الخروج', () => { updateUserActivity("سجل الخروج"); const userToLogOut = { ...currentUser }; localStorage.removeItem('moraUser'); currentUser = null; document.getElementById('generic-modal').classList.remove('open'); showPage('auth-page'); renderAuthForm(false, false); if (userToLogOut && userToLogOut.name) { document.getElementById('auth-name').value = userToLogOut.name; document.getElementById('auth-password').value = userToLogOut.password || ''; } initVantaBackground(); }); }
        // ✅ مراقبة حذف الحساب من لوحة التحكم
        function listenForUserBanOrDeletion() {
            if (!currentUser || currentUser.isAdmin || !currentUser.id) return;
            const userDocRef = doc(db, "users", currentUser.id);
            onSnapshot(userDocRef, (doc) => {
                if (!doc.exists()) {
                    // تم حذف الحساب من لوحة التحكم
                    handleImmediateBan("تم حذف حسابك من النظام.");
                    return;
                }
                const data = doc.data();
                if (data.isBanned) {
                    handleImmediateBan("تم حظر حسابك نهائياً.");
                    return;
                }
                currentUser = { id: doc.id, ...data };
                localStorage.setItem('moraUser', JSON.stringify(currentUser));
            });
            let ipAddress = 'N/A';
            fetch('https://api.ipify.org?format=json').then(res => res.json()).then(ipData => {
                ipAddress = ipData.ip;
                const ipDocRef = doc(db, "banned_ips", ipAddress);
                onSnapshot(ipDocRef, (ipDoc) => {
                    if (ipDoc.exists()) {
                        handleImmediateBan("تم حظر جهازك من استخدام الموقع.");
                    }
                });
            }).catch(() => {});
        }
        function handleImmediateBan(message) {
            localStorage.removeItem('moraUser');
            currentUser = null;
            showToast(message, true);
            setTimeout(() => {
                showPage('auth-page');
                renderAuthForm(false, false);
                initVantaBackground();
            }, 3000);
        }
        // ======================= TIMER =======================
        let timerInterval; let timerState = { running: false, duration: 25 * 60 };
        function formatTime(seconds) { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; }
        function updateTimerDisplay() { const display = document.getElementById('timer-display'); if(display) display.textContent = formatTime(timerState.duration); }
        function startTimer() { 
            document.getElementById('timer-start-sound').play();
            timerState.running = true; 
            document.getElementById('timer-start-btn').textContent = 'إيقاف مؤقت'; 
            document.getElementById('timer-live-indicator').classList.remove('hidden');
            document.getElementById('generic-modal').classList.remove('open');
            timerInterval = setInterval(() => { 
                timerState.duration--; 
                updateTimerDisplay(); 
                if (timerState.duration < 0) { 
                    stopTimer(true); 
                } 
            }, 1000); 
        }
        function stopTimer(finished = false) { 
            clearInterval(timerInterval); 
            timerState.running = false; 
            document.getElementById('timer-live-indicator').classList.add('hidden');
            const startBtn = document.getElementById('timer-start-btn'); 
            if(startBtn) startBtn.textContent = 'بدء'; 
            if(finished){ 
                document.getElementById('timer-end-sound').play();
                openModalWithContent('انتهى الوقت!', '<div class="text-center p-8"><i class="ph-confetti text-6xl text-[var(--primary-glow)] mb-4"></i><h3 class="text-xl font-bold mb-2">أحسنت!</h3><p class="text-slate-400">لقد أكملت جلسة مذاكرة.</p></div>'); 
                timerState.duration = 25*60; 
            } 
        }
        // ======================= THEMES =======================
        const themes = { "default":{n:"افتراضي",p:"#00f5c3",s:"#a78bfa"},"gold":{n:"ذهبي",p:"#f59e0b",s:"#fbbf24"},"emerald":{n:"زمردي",p:"#10b981",s:"#34d399"},"crimson":{n:"قرمزي",p:"#dc2626",s:"#f87171"},"violet":{n:"بنفسجي",p:"#8b5cf6",s:"#c084fc"},"rose":{n:"وردي",p:"#f43f5e",s:"#fb7185"},"sky":{n:"سماوي",p:"#0ea5e9",s:"#38bdf8"},"forest":{n:"غابي",p:"#22c55e",s:"#4ade80"},"ocean":{n:"محيط",p:"#0891b2",s:"#22d3ee"},"sunset":{n:"غروب",p:"#f97316",s:"#f59e0b"},"galaxy":{n:"مجرة",p:"#9333ea",s:"#d946ef"},"candy":{n:"حلوى",p:"#ec4899",s:"#f87171"},"lime":{n:"ليموني",p:"#84cc16",s:"#a3e635"},"fire":{n:"ناري",p:"#f59e0b",s:"#ef4444"},"ice":{n:"جليدي",p:"#22d3ee",s:"#67e8f9"},"royal":{n:"ملكي",p:"#d97706",s:"#f59e0b"},"hacker":{n:"هاكر",p:"#16a34a",s:"#4ade80"},"retro":{n:"ريترو",p:"#ca8a04",s:"#eab308"},"sakura":{n:"ساكورا",p:"#f472b6",s:"#fb7185"},"mint":{n:"نعناع",p:"#2dd4bf",s:"#5eead4"},"copper":{n:"نحاسي",p:"#b45309",s:"#d97706"},"lavender":{n:"خزامي",p:"#a78bfa",s:"#c4b5fd"},"cyber":{n:"سايبر",p:"#ea580c",s:"#f59e0b"},"sand":{n:"رملي",p:"#ca8a04",s:"#eab308"},"grape":{n:"عنبي",p:"#9333ea",s:"#a855f7"},"cherry":{n:"كرزي",p:"#be123c",s:"#e11d48"},"peach":{n:"خوخي",p:"#f97316",s:"#fb923c"},"teal":{n:"بطيخي",p:"#0d9488",s:"#14b8a6"},"indigo":{n:"نيلي",p:"#4f46e5",s:"#6366f1"},"amber":{n:"عنبري",p:"#d97706",s:"#f59e0b"},"fuchsia":{n:"فوشيا",p:"#c026d3",s:"#d946ef"} };
        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            if (!theme) return;
            const style = document.getElementById('theme-style-root');
            const hexToRgb = hex => hex.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i, (m, r, g, b) => '#' + r + r + g + g + b + b).substring(1).match(/.{2}/g).map(x => parseInt(x, 16)).join(', ');
            style.innerHTML = `
                :root {
                    --bg-color: #0d0d1a; 
                    --primary-glow: ${theme.p}; --primary-glow-rgb: ${hexToRgb(theme.p)};
                    --secondary-glow: ${theme.s}; --secondary-glow-rgb: ${hexToRgb(theme.s)};
                    --text-primary: #e2e8f0; --text-secondary: #94a3b8;
                    --glass-bg: rgba(15, 23, 42, 0.7); --glass-border: rgba(${hexToRgb(theme.p)}, 0.1);
                    --shadow-color: rgba(0, 0, 0, 0.37);
                }
            ` + style.innerHTML.split('}').slice(1).join('}');
            localStorage.setItem('moraTheme', themeKey);
        }
        // ======================= TEXTS =======================
        function applySiteTexts() {
            document.querySelectorAll('[data-text-key]').forEach(el => {
                const key = el.dataset.textKey;
                if (siteTexts[key]) {
                    el.textContent = siteTexts[key];
                }
            });
        }
        async function listenToSiteContent() {
            const textDocRef = doc(db, 'site_content', 'texts');
            const docSnap = await getDoc(textDocRef);
            if (!docSnap.exists()) {
                await setDoc(textDocRef, defaultTexts);
                siteTexts = defaultTexts;
            } else {
                siteTexts = docSnap.data();
            }
            applySiteTexts();
            onSnapshot(textDocRef, (doc) => {
                siteTexts = doc.data() || defaultTexts;
                applySiteTexts();
            });
        }
        // ======================= ADMIN DASHBOARD =======================
        function initAdminDashboard() { 
            showPage('admin-dashboard'); 
            const navBtns = document.querySelectorAll('.admin-nav-btn'), panels = document.querySelectorAll('.admin-panel'); 
            navBtns.forEach(btn => btn.addEventListener('click', e => { navBtns.forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active'); panels.forEach(p => p.classList.add('hidden')); document.getElementById(e.currentTarget.dataset.panel).classList.remove('hidden'); })); 
            navBtns[0].click(); 
            initTextManagementPanel();
            onSnapshot(collection(db, "users"), (snap) => { adminDashboardEl.studentCount.textContent = snap.size; }); 
            onSnapshot(collection(db, "opinions"), (snap) => { adminDashboardEl.opinionsCount.textContent = snap.size; }); 
            onSnapshot(collection(db, "polls"), (snap) => { adminDashboardEl.pollsCount.textContent = snap.size; });
            onSnapshot(collection(db, "notifications"), (snap) => { adminDashboardEl.notificationsCount.textContent = snap.size; }); 
            onSnapshot(query(collection(db, "users"), orderBy('lastActivity.timestamp', 'desc')), s => { 
                let h = ''; 
                s.forEach(d => { 
                    const u = d.data(), b = u.isBanned || false; 
                    const activity = u.lastActivity ? `<p class="text-xs mt-1 text-cyan-400">النشاط الحالي: ${u.lastActivity.description}</p>` : '';
                    const banStatus = b ? '<span class="text-red-400 font-bold">[محظور]</span>' : '';
                    h += `<div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg text-white">${u.name} ${banStatus}</p>
                                    <p class="text-sm text-slate-400">${u.city || 'N/A'}, ${u.country || 'N/A'}</p>
                                    ${activity}
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <button onclick="banIp('${u.ipAddress}')" class="px-3 py-1 text-sm rounded bg-orange-600">حظر IP</button>
                                    <button onclick="toggleBan('${d.id}', ${b})" class="px-3 py-1 text-sm rounded ${b ? 'bg-green-600' : 'bg-yellow-600'}">${b ? 'فك الحظر' : 'حظر'}</button>
                                    <button onclick="deleteUser('${d.id}')" class="px-3 py-1 text-sm rounded bg-red-600">حذف</button>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-slate-700/50 text-xs text-slate-300">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 font-mono text-[11px]">
                                    <p><b>ID:</b> ${u.studentId || 'NO-ID'}</p>
                                    <p><b>IP:</b> ${u.ipAddress || 'N/A'}</p>
                                    <p><b>التخصص:</b> ${u.year} | ${u.division === 'international' ? 'IB' : 'BIS'}</p>
                                    <p><b>تاريخ التسجيل:</b> ${u.createdAt ? u.createdAt.toDate().toLocaleString('ar-EG') : ''}</p>
                                    <p><b>كلمة المرور:</b> ${u.password}</p>
                                </div>
                            </div>
                          </div>`; 
                }); 
                adminDashboardEl.studentsList.innerHTML = h; 
            }); 
            onSnapshot(query(collection(db, "opinions"), orderBy('createdAt', 'desc')), s => { let h = ''; s.forEach(d => { const o = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p>"${o.text}"</p><p class="text-sm text-slate-400 mt-2 font-bold">${o.name} - فرقة ${o.year}</p></div><button onclick="deleteFromCollection('${d.id}', 'opinions')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div>`; }); adminDashboardEl.opinionsList.innerHTML = h; }); 
            onSnapshot(query(collection(db, "polls"), orderBy('createdAt', 'desc')), s => {
                let h = '';
                s.forEach(d => {
                    const poll = d.data();
                    const divisionText = poll.userDivision === 'international' ? 'أعمال دولية' : 'نظم معلومات';
                    const yearText = poll.userYear === '1' ? 'الفرقة الأولى' : 'الثانية';
                    const dateText = poll.createdAt ? poll.createdAt.toDate().toLocaleString('ar-EG') : '';
                    h += `
                        <div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-white">${poll.topic}</p>
                                    <p class="text-xs text-slate-400 mt-1">
                                        بواسطة: ${poll.userName} (${yearText} - ${divisionText})<br>
                                        ${dateText}
                                    </p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="toggleAdminRepliesView('replies-${d.id}')" class="px-3 py-1 text-sm rounded bg-sky-600">عرض الردود</button>
                                    <button onclick="deletePollWithReplies('${d.id}')" class="px-3 py-1 text-sm rounded bg-red-600">حذف</button>
                                </div>
                            </div>
                            <div id="replies-${d.id}" class="hidden mt-3 pt-3 border-t border-slate-700/50 space-y-2">
                                <p class="text-center text-slate-400">جاري تحميل الردود...</p>
                            </div>
                        </div>`;
                });
                adminDashboardEl.pollsList.innerHTML = h || '<p class="text-center text-slate-400">لا توجد استطلاعات حالياً.</p>';
            });
            onSnapshot(query(collection(db, "courses"), orderBy('createdAt', 'desc')), s => { let h = ''; s.forEach(d => { const c = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p class="font-bold text-white">${c.title} <span class="text-xs text-slate-400">(${c.category || 'بدون فئة'})</span></p><p class="text-sm text-slate-400">${c.desc}</p></div><button onclick="deleteFromCollection('${d.id}', 'courses')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div>`; }); adminDashboardEl.coursesList.innerHTML = h; }); 
            onSnapshot(query(collection(db, "ai_tools"), orderBy('name')), s => { let h = ''; s.forEach(d => { const t = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p class="font-bold text-white">${t.name}</p><p class="text-sm text-slate-400">${t.desc}</p></div><button onclick="deleteFromCollection('${d.id}', 'ai_tools')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div>`; }); adminDashboardEl.aiToolsList.innerHTML = h; }); 
            onSnapshot(query(collection(db, "notifications"), orderBy('createdAt', 'desc')), s => { let h = ''; s.forEach(d => { const n = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p class="font-bold text-white">${n.title || ''}</p><p class="text-sm text-slate-300">${n.body}</p><p class="text-xs text-slate-500 mt-2">${n.createdAt.toDate().toLocaleString('ar-EG')}</p></div><button onclick="deleteFromCollection('${d.id}', 'notifications')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div>`; }); adminDashboardEl.notificationsList.innerHTML = h; }); 
            onSnapshot(query(collection(db, "support_tickets"), orderBy('createdAt', 'desc')), s => {
                const container = document.getElementById('admin-tickets-list');
                let h = '';
                if(s.empty) { h = '<p class="text-slate-400 text-center">لا توجد شكاوى حالياً.</p>'; }
                s.forEach(d => {
                    const t = d.data();
                    const replySection = t.adminReply 
                        ? `<div class="mt-3 pt-3 border-t border-green-500/30"><p class="text-xs text-slate-400">ردك:</p><p class="text-sm text-green-300">${t.adminReply}</p></div>`
                        : `<div class="mt-3"><textarea id="reply-${d.id}" class="w-full rounded-lg input-field" rows="2" placeholder="اكتب ردك هنا..."></textarea><button onclick="replyToTicket('${d.id}')" class="w-full mt-2 py-2 rounded-lg text-sm font-bold btn-celestial">إرسال الرد</button></div>`;
                    const statusBadge = t.status === 'تم الرد' ? 'bg-green-500' : 'bg-yellow-500';
                    h += `<div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-white">${t.userName}</p>
                                    <p class="text-xs text-slate-400">${t.createdAt.toDate().toLocaleString('ar-EG')}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold text-white px-2 py-1 rounded-full ${statusBadge}">${t.status}</span>
                                    <button onclick="deleteFromCollection('${d.id}', 'support_tickets')" class="text-red-500 hover:text-red-400 text-lg p-1"><i class="ph-trash"></i></button>
                                </div>
                            </div>
                            <p class="mt-3 text-slate-200">${t.problem}</p>
                            ${replySection}
                          </div>`;
                });
                if(container) container.innerHTML = h;
            });
            // ✅ Attendance Panel with Delete Button (only from attendance, not users)
            const attendanceRef = collection(db, "attendance");
            onSnapshot(query(attendanceRef, orderBy("timestamp", "desc")), (snapshot) => {
                const container = document.getElementById('attendance-list');
                if (!container) return;
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-slate-400">لا يوجد حضور مسجل حتى الآن.</p>';
                    return;
                }
                let html = '<div class="space-y-3">';
                snapshot.forEach(doc => {
                    const att = doc.data();
                    const device = parseUserAgent(att.userAgent);
                    const time = att.timestamp ? att.timestamp.toDate().toLocaleString('ar-EG') : 'غير معروف';
                    html += `
                        <div class="glass-effect p-3 rounded-lg flex justify-between items-start">
                            <div>
                                <p class="font-bold text-white">${att.userName}</p>
                                <p class="text-sm text-slate-400">${att.userDivision === 'international' ? 'IB' : 'BIS'} - ${att.userYear}</p>
                                <p class="text-xs text-slate-500 mt-1">الوقت: ${time}</p>
                                <p class="text-xs text-slate-500">الجهاز: ${device} | IP: ${att.ipAddress || 'N/A'}</p>
                            </div>
                            <button onclick="deleteAttendanceRecord('${doc.id}')" class="text-red-500 hover:text-red-400 text-lg p-1"><i class="ph-trash"></i></button>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            });
            listenForNewAdminNotifications();
            const updateSubjects = () => { const y = adminContentPanelEl.year.value, d = adminContentPanelEl.division.value; adminContentPanelEl.subject.innerHTML = '<option value="">اختر المادة</option>'; if (y && d) { (materials['ar'][`${y}_${d}`] || []).forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; adminContentPanelEl.subject.appendChild(o); }); } displayAdminContent(); }; 
            ['content-type-select', 'content-year-select', 'content-division-select', 'content-subject-select'].forEach(id => document.getElementById(id).addEventListener('change', id.includes('subject') ? displayAdminContent : updateSubjects)); 
            const siteSettingsRef = doc(db, 'settings', 'site'); 
            onSnapshot(siteSettingsRef, (docSnap) => {
                const settings = docSnap.data() || {};
                const meetLinkInput = document.getElementById('meet-link-input');
                const statusIndicator = document.getElementById('stream-status-indicator');
                const startBtn = document.getElementById('start-stream-btn');
                const endBtn = document.getElementById('end-stream-btn');
                if (meetLinkInput) meetLinkInput.value = settings.meetLink || '';
                if (settings.isLive) {
                    statusIndicator.textContent = 'مباشر الآن';
                    statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-bold bg-red-500 text-white live-pulse';
                    startBtn.disabled = true;
                    endBtn.disabled = false;
                } else {
                    statusIndicator.textContent = 'متوقف';
                    statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-bold bg-slate-600 text-slate-300';
                    startBtn.disabled = false;
                    endBtn.disabled = true;
                }
            });
            document.getElementById('save-meet-link-btn').addEventListener('click', async () => {
                const link = document.getElementById('meet-link-input').value.trim();
                if (link && link.startsWith('https://meet.google.com/')) {
                    await setDoc(siteSettingsRef, { meetLink: link }, { merge: true });
                    showToast('تم حفظ رابط البث المباشر بنجاح!');
                } else {
                    showToast('الرجاء إدخال رابط جوجل ميت صحيح.', true);
                }
            });
            document.getElementById('start-stream-btn').addEventListener('click', () => setDoc(siteSettingsRef, { isLive: true }, { merge: true }));
            document.getElementById('end-stream-btn').addEventListener('click', () => setDoc(siteSettingsRef, { isLive: false }, { merge: true }));
            // ✅ قسم تحميل التطبيق
            const appDownloadsRef = collection(db, "app_downloads");
            onSnapshot(appDownloadsRef, (snapshot) => {
                document.getElementById('app-downloads-count').textContent = snapshot.size;
            });
            document.getElementById('view-downloads-btn').addEventListener('click', async () => {
                const snapshot = await getDocs(query(appDownloadsRef, orderBy('timestamp', 'desc')));
                let html = '<div class="space-y-3 max-h-80 overflow-y-auto">';
                if (snapshot.empty) {
                    html += '<p class="text-center text-slate-400">لا توجد تنزيلات بعد.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const device = parseUserAgent(d.userAgent);
                        const time = d.timestamp ? d.timestamp.toDate().toLocaleString('ar-EG') : 'غير معروف';
                        html += `
                            <div class="download-item">
                                <p class="font-bold text-white">${d.userName}</p>
                                <p class="text-sm text-slate-400">${d.userDivision === 'international' ? 'IB' : 'BIS'} - ${d.userYear}</p>
                                <p class="download-meta">الجهاز: ${device} | IP: ${d.ipAddress || 'N/A'} | ${time}</p>
                            </div>
                        `;
                    });
                }
                html += '</div>';
                openModalWithContent('سجل تنزيلات التطبيق', html);
            });
            // ✅ COURSES CATEGORIES
            const coursesRef = collection(db, "courses");
            const categoriesRef = collection(db, "course_categories");
            onSnapshot(categoriesRef, (snapshot) => {
                const select = document.getElementById('course-category-select');
                select.innerHTML = '<option value="">اختر الفئة</option>';
                snapshot.forEach(doc => {
                    const cat = doc.data();
                    const opt = document.createElement('option');
                    opt.value = cat.name;
                    opt.textContent = cat.name;
                    select.appendChild(opt);
                });
            });
            document.getElementById('add-course-category-btn').addEventListener('click', async () => {
                const name = document.getElementById('course-category-input').value.trim();
                if (!name) {
                    showToast('يرجى إدخال اسم الفئة', true);
                    return;
                }
                const q = query(categoriesRef, where("name", "==", name));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    showToast('الفئة موجودة بالفعل', true);
                    return;
                }
                await addDoc(categoriesRef, { name, createdAt: serverTimestamp() });
                document.getElementById('course-category-input').value = '';
                showToast('تمت إضافة الفئة!');
            });
        }
        // ✅ Delete ONLY attendance record (not user)
        window.deleteAttendanceRecord = async (recordId) => {
            if (!confirm('هل أنت متأكد من حذف سجل الحضور لهذا الطالب؟ لن يتمكن من الدخول إلى البث المباشر مستقبلاً، لكن حسابه سيظل نشطًا في الموقع.')) return;
            try {
                await deleteDoc(doc(db, "attendance", recordId));
                showToast('تم حذف سجل الحضور بنجاح.');
            } catch (error) {
                console.error("Error deleting attendance record:", error);
                showToast("حدث خطأ أثناء الحذف.", true);
            }
        };
        async function displayAdminContent() { const { type, year, division, subject, contentList } = adminContentPanelEl; const coll = type.value; const filters = [ where("year", "==", year.value), where("division", "==", division.value) ]; if (subject.value) filters.push(where("subject", "==", subject.value)); if (!year.value || !division.value) { contentList.innerHTML = '<p class="text-center text-slate-400">اختر الفرقة والشعبة لعرض المحتوى.</p>'; return; } const q = query(collection(db, coll), ...filters); onSnapshot(q, (snapshot) => { let h = ''; if (snapshot.empty) { h = '<p class="text-center text-slate-400">لا يوجد محتوى يطابق هذا الفلتر.</p>'; } else { snapshot.forEach(doc => { const item = doc.data(); h += `<div class="p-3 rounded-lg flex justify-between items-center hover:bg-slate-500/10 transition"><p class="font-semibold text-white truncate">${item.title} (${item.subject})</p><div class="flex gap-2"><button onclick="populateContentForm('${doc.id}', '${coll}')" class="text-sky-400 hover:text-sky-300 text-lg"><i class="ph-pencil-simple"></i></button><button onclick="toggleContentVisibility('${doc.id}', '${coll}', ${item.isHidden || false})" class="text-yellow-400 hover:text-yellow-300 text-lg"><i class="ph ${item.isHidden ? 'ph-eye-slash' : 'ph-eye'}"></i></button><button onclick="deleteContent('${doc.id}', '${coll}')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div></div>`; }); } contentList.innerHTML = h; }); }
        window.populateContentForm = async (id, coll) => { const docSnap = await getDoc(doc(db, coll, id)); if (docSnap.exists()) { const item = docSnap.data(); adminContentPanelEl.title.value = item.title; adminContentPanelEl.body.value = item.body; adminContentPanelEl.subject.value = item.subject; adminContentPanelEl.formTitle.textContent = 'تعديل المحتوى'; adminContentPanelEl.saveBtn.textContent = 'حفظ التعديلات'; adminContentPanelEl.cancelBtn.classList.remove('hidden'); currentEditState = { id, collection: coll }; } }
        function resetContentForm() { adminContentPanelEl.formTitle.textContent = 'إضافة محتوى جديد'; adminContentPanelEl.saveBtn.textContent = 'حفظ'; adminContentPanelEl.cancelBtn.classList.add('hidden'); adminContentPanelEl.title.value = ''; adminContentPanelEl.body.value = ''; currentEditState = { id: null, collection: null }; }
        async function initTextManagementPanel(){
            const formContainer = document.getElementById('text-management-form');
            const textsRef = doc(db, 'site_content', 'texts');
            let currentTexts = (await getDoc(textsRef)).data() || defaultTexts;
            let formHTML = '';
            for(const key in textLabels){
                formHTML += `
                    <div class="glass-effect p-4 rounded-lg">
                        <label for="text-${key}" class="block text-sm font-bold text-slate-400 mb-2">${textLabels[key]}</label>
                        <textarea id="text-${key}" data-key="${key}" class="w-full rounded-lg input-field" rows="2">${currentTexts[key] || ''}</textarea>
                    </div>
                `;
            }
            formContainer.innerHTML = formHTML;
            document.getElementById('save-texts-btn').addEventListener('click', async () => {
                const newTexts = {};
                formContainer.querySelectorAll('textarea').forEach(area => {
                    newTexts[area.dataset.key] = area.value;
                });
                try {
                    await setDoc(textsRef, newTexts);
                    showToast("تم حفظ النصوص بنجاح!");
                } catch(e) {
                    showToast("حدث خطأ أثناء الحفظ.", true);
                }
            });
        }
        window.deleteFromCollection = async (id, coll) => { if(confirm('هل أنت متأكد من الحذف؟')) { await deleteDoc(doc(db, coll, id)); showToast('تم الحذف بنجاح.'); }};
        window.deleteContent = (id, coll) => deleteFromCollection(id, coll);
        window.deleteUser = (id) => deleteFromCollection(id, 'users');
        window.toggleBan = async (id, ban) => { if(confirm(`هل أنت متأكد من ${ban ? 'إلغاء حظر' : 'حظر'} هذا الطالب؟`)) { await updateDoc(doc(db, 'users', id), { isBanned: !ban }); showToast('تم تحديث حالة الطالب.'); } };
        window.banIp = async (ip) => { if(ip && ip !== 'N/A' && confirm(`هل أنت متأكد من حظر الـ IP: ${ip}؟
سيمنع هذا أي شخص يستخدم هذا الـ IP من دخول الموقع.`)) { await setDoc(doc(db, 'banned_ips', ip), { bannedAt: serverTimestamp() }); showToast(`تم حظر الـ IP ${ip} بنجاح.`); }};
        window.toggleContentVisibility = async (id, coll, isHidden) => { await updateDoc(doc(db, coll, id), { isHidden: !isHidden }); showToast(`تم ${isHidden ? 'إظهار' : 'إخفاء'} المحتوى.`); };
        window.replyToTicket = async (ticketId) => {
            const replyText = document.getElementById(`reply-${ticketId}`).value.trim();
            if (!replyText) { showToast("لا يمكن إرسال رد فارغ.", true); return; }
            await updateDoc(doc(db, "support_tickets", ticketId), {
                adminReply: replyText,
                status: "تم الرد",
                resolvedAt: serverTimestamp(),
                isReadByStudent: false
            });
            showToast("تم إرسال الرد بنجاح.");
        };
        document.getElementById('send-notification-btn').addEventListener('click', async () => { const title = document.getElementById('notification-title-input').value.trim(); const body = document.getElementById('notification-body-input').value.trim(); if (!body) { showToast('نص الإشعار لا يمكن أن يكون فارغاً', true); return; } await addDoc(collection(db, 'notifications'), { title, body, createdAt: serverTimestamp() }); showToast('تم إرسال الإشعار بنجاح!'); document.getElementById('notification-title-input').value = ''; document.getElementById('notification-body-input').value = ''; });
        document.getElementById('add-course-btn').addEventListener('click', async () => { 
            const title = document.getElementById('course-title-input').value.trim();
            const desc = document.getElementById('course-desc-input').value.trim();
            const category = document.getElementById('course-category-select').value.trim();
            const url = document.getElementById('course-url-input').value.trim();
            if (!title || !desc || !url || !category) { showToast('يرجى ملء جميع الحقول', true); return; } 
            await addDoc(collection(db, 'courses'), { title, desc, url, category, createdAt: serverTimestamp() }); 
            showToast('تمت إضافة الكورس!'); 
            document.getElementById('course-title-input').value = ''; 
            document.getElementById('course-desc-input').value = '';
            document.getElementById('course-url-input').value = '';
        });
        document.getElementById('add-ai-tool-btn').addEventListener('click', async () => { const name = document.getElementById('ai-name-input').value.trim(), desc = document.getElementById('ai-desc-input').value.trim(), url = document.getElementById('ai-url-input').value.trim(); if (!name || !desc || !url) { showToast('يرجى ملء جميع الحقول', true); return; } await addDoc(collection(db, 'ai_tools'), { name, desc, url }); showToast('تمت إضافة الأداة!'); document.getElementById('ai-name-input').value = ''; document.getElementById('ai-desc-input').value = ''; document.getElementById('ai-url-input').value = ''; });
        adminContentPanelEl.saveBtn.addEventListener('click', async () => { try { const { year, division, subject, title, body, type } = adminContentPanelEl; const data = { year: year.value, division: division.value, subject: subject.value, title: title.value.trim(), body: body.value.trim() }; if (!data.year || !data.division || !data.subject || !data.title || !data.body) { showToast('يرجى ملء جميع الحقول', true); return; } if (currentEditState.id) { await updateDoc(doc(db, currentEditState.collection, currentEditState.id), data); showToast('تم تحديث المحتوى!'); } else { data.createdAt = serverTimestamp(); data.isHidden = false; await addDoc(collection(db, type.value), data); showToast('تم حفظ المحتوى!'); } resetContentForm(); } catch(e) { showToast('حدث خطأ: ' + e.message, true); }});
        // Admin: Toggle replies view
        window.toggleAdminRepliesView = (containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            const isHidden = container.classList.contains('hidden');
            if (isHidden) {
                container.classList.remove('hidden');
                const pollId = containerId.replace('replies-', '');
                const pollDocRef = doc(db, "polls", pollId);
                const repliesQuery = query(collection(pollDocRef, "replies"), orderBy("createdAt", "asc"));
                onSnapshot(repliesQuery, (snapshot) => {
                    let repliesHTML = '';
                    if (snapshot.empty) {
                        repliesHTML = '<p class="text-slate-400 text-center">لا توجد ردود.</p>';
                    } else {
                        snapshot.forEach(doc => {
                            const reply = doc.data();
                            repliesHTML += `
                                <div class="p-2 rounded-lg bg-slate-800/50 flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-slate-200">${reply.replyText}</p>
                                        <p class="text-xs text-slate-500 mt-1">${reply.userName}</p>
                                    </div>
                                    <button onclick="deleteReply('${pollId}', '${doc.id}')" class="text-red-500 hover:text-red-400 text-lg flex-shrink-0 ml-2"><i class="ph-trash"></i></button>
                                </div>
                            `;
                        });
                    }
                    container.innerHTML = repliesHTML;
                });
            } else {
                container.classList.add('hidden');
                container.innerHTML = '<p class="text-center text-slate-400">جاري تحميل الردود...</p>';
            }
        }
        // Admin: Delete poll with replies
        window.deletePollWithReplies = async (pollId) => {
            if (!confirm('هل أنت متأكد من حذف هذا الموضوع وكل الردود المتعلقة به؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            const pollRef = doc(db, 'polls', pollId);
            const repliesRef = collection(pollRef, 'replies');
            const repliesSnapshot = await getDocs(repliesRef);
            const batch = writeBatch(db);
            repliesSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            await deleteDoc(pollRef);
            showToast('تم حذف الاستطلاع وكل الردود.');
        }
        // Admin: Delete single reply
        window.deleteReply = async (pollId, replyId) => {
            if (!confirm('هل أنت متأكد من حذف هذا الرد؟')) return;
            const replyRef = doc(db, 'polls', pollId, 'replies', replyId);
            await deleteDoc(replyRef);
            showToast('تم حذف الرد.');
        }
        // ======================= INITIALIZATION =======================
        window.addEventListener('load', async () => {
            await listenToSiteContent();
            const savedTheme = localStorage.getItem('moraTheme') || 'default';
            applyTheme(savedTheme);
            const savedUser = localStorage.getItem('moraUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showPage('splash-screen');
                window.addEventListener('visibilitychange', () => {
                   if (document.visibilityState === 'hidden') {
                        updateUserActivity("غادر الموقع");
                   } else {
                        updateUserActivity("عاد للموقع");
                   }
                });
                listenForUserBanOrDeletion();
            } else {
                showPage('auth-page');
                renderAuthForm();
                initVantaBackground();
            }
        });
        document.getElementById('splash-screen').addEventListener('animationend', () => { setTimeout(() => { if (currentUser.isAdmin) { initAdminDashboard(); } else { initStudentDashboard(); } }, 100); });
        document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('exit-focus-mode-btn').addEventListener('click', () => { document.querySelector('.bottom-nav-btn[data-modal="settings-modal"]').click(); });
        document.getElementById('generic-modal').addEventListener('click', e => { 
            if (e.target.classList.contains('modal')) {
                if(modalCloseBtn.onclick) modalCloseBtn.onclick();
            }
        });
        modalCloseBtn.addEventListener('click', () => {
            if(modalCloseBtn.onclick) modalCloseBtn.onclick();
        });

        // === NEW: AI Avatar System ===
        let aiAvatarScene, aiAvatarCamera, aiAvatarRenderer, aiAvatarCube;
        let aiMessages = [
            "مرحباً! أنا مرشدك الافتراضي 🌟",
            "هل جربت تايمر المذاكرة؟",
            "لا تنسَ حضور البث المباشر!",
            "شارك رأيك في قسم الآراء!",
            "جرب كورسات الذكاء الاصطناعي!",
            "احرص على المراجعة بعد كل محاضرة!"
        ];
        let lastMessageIndex = -1;

        function initAIAvatar() {
            const container = document.getElementById('ai-avatar-container');
            const canvas = document.getElementById('ai-avatar-canvas');
            container.classList.remove('hidden');

            aiAvatarScene = new THREE.Scene();
            aiAvatarCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            aiAvatarRenderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            aiAvatarRenderer.setSize(60, 60);

            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshBasicMaterial({ color: 0x00f5c3 });
            aiAvatarCube = new THREE.Mesh(geometry, material);
            aiAvatarScene.add(aiAvatarCube);

            aiAvatarCamera.position.z = 2;

            animateAIAvatar();
            showRandomMessage();
            setInterval(showRandomMessage, 15000);
        }

        function animateAIAvatar() {
            requestAnimationFrame(animateAIAvatar);
            if (aiAvatarCube) {
                aiAvatarCube.rotation.x += 0.01;
                aiAvatarCube.rotation.y += 0.01;
            }
            aiAvatarRenderer.render(aiAvatarScene, aiAvatarCamera);
        }

        function showRandomMessage() {
            if (document.body.classList.contains('focus-mode')) return;
            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * aiMessages.length);
            } while (newIndex === lastMessageIndex && aiMessages.length > 1);
            lastMessageIndex = newIndex;
            const msgEl = document.getElementById('ai-avatar-message');
            msgEl.textContent = aiMessages[newIndex];
            msgEl.classList.remove('show');
            void msgEl.offsetWidth; // trigger reflow
            msgEl.classList.add('show');
            setTimeout(() => {
                if (!msgEl.matches(':hover')) {
                    msgEl.classList.remove('show');
                }
            }, 5000);
        }

        // === NEW: Focus Mode Toggle ===
        function toggleFocusMode() {
            document.body.classList.toggle('focus-mode');
            const isFocused = document.body.classList.contains('focus-mode');
            localStorage.setItem('focusMode', isFocused);
            const icon = document.getElementById('focus-mode-btn').querySelector('i');
            icon.className = isFocused ? 'ph-x' : 'ph-target';
        }

        // Initialize focus mode from localStorage
        if (localStorage.getItem('focusMode') === 'true') {
            document.body.classList.add('focus-mode');
        }
    </script>
</body>
</html>
